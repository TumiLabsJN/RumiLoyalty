# API STRUCTURE DOCUMENTATION - MISSIONS ENDPOINTS

**Platform:** Rumi Loyalty Platform
**Purpose:** Define expected API response structures for frontend consumption
**Last Updated:** 2025-01-10

---

## MISSIONS API RESPONSE STRUCTURE

### Problem Statement

The frontend mock data in `missions/page.tsx` uses fields from **both** the `missions` table AND the `mission_progress` table in a flattened structure. This document clarifies the expected API response format.

### Backend Requirement

The backend API **MUST** join `missions` and `mission_progress` tables and return a **flattened, merged object** to the frontend.

---

## GET /api/missions - Creator's Active Missions

### Query Logic

```sql
-- Backend joins missions + mission_progress + benefits tables
SELECT
  -- From missions table (template data)
  m.id as mission_id,
  m.mission_type,
  m.title, -- Admin reference (not shown to creators)
  m.target_value,
  m.benefit_id,
  m.tier_eligibility,
  m.raffle_end_date,
  m.raffle_prize_name,
  m.activated,
  m.enabled,

  -- From mission_progress table (user-specific data)
  mp.id as progress_id,
  mp.current_value,
  mp.status,
  mp.completed_at,
  mp.claimed_at,
  mp.fulfilled_at,
  mp.checkpoint_start,
  mp.checkpoint_end,  -- ← This is where checkpoint_end comes from!

  -- From benefits table (reward data)
  b.type as reward_type,
  b.value_data as reward_value_data,
  b.description as reward_description

FROM missions m
LEFT JOIN mission_progress mp ON m.id = mp.mission_id
  AND mp.user_id = :user_id
  AND mp.checkpoint_start = :current_checkpoint_start
LEFT JOIN benefits b ON m.benefit_id = b.id

WHERE m.client_id = :client_id
  AND m.enabled = true
  AND (
    -- Show missions user is eligible for
    m.tier_eligibility = :user_current_tier OR
    m.tier_eligibility = 'all' OR
    -- Show locked preview missions
    (m.preview_from_tier IS NOT NULL AND :user_tier_level >= :preview_tier_level)
  )

ORDER BY
  CASE mp.status
    WHEN 'won' THEN 1
    WHEN 'completed' THEN 2
    WHEN 'claimed' THEN 3
    WHEN 'processing' THEN 4
    WHEN 'active' THEN 5
    ELSE 6
  END,
  m.mission_type,
  m.display_order;
```

---

## Response Format

### Success Response

```typescript
{
  "success": true,
  "missions": [
    {
      // Template data (from missions table)
      "id": "mission-uuid-1",
      "mission_type": "sales",
      "display_name": "Unlock Payday",  // ← Backend computes from hardcoded mapping
      "description": "Reach your sales target",  // ← Backend computes from hardcoded mapping
      "target_value": 2000,
      "tier_eligibility": "tier_3",
      "raffle_prize_name": null,
      "raffle_end_date": null,
      "activated": false,  // Ignored for non-raffle missions
      "enabled": true,
      "required_tier": null,  // ← Backend computes: NULL if eligible, tier name if locked

      // Progress data (from mission_progress table)
      "current_progress": 1500,
      "progress_percentage": 75,  // ← Backend computes: (current_progress / target_value) * 100
      "remaining_value": 500,  // ← Backend computes: target_value - current_progress
      "status": "active",  // ← Backend computes virtual status (available/dormant/locked)
      "checkpoint_end": "2025-03-15T23:59:59Z",  // ← From mission_progress.checkpoint_end

      // Reward data (from benefits table)
      "reward_type": "gift_card",
      "reward_value": 50,  // ← Backend extracts from value_data JSONB
      "reward_custom_text": null,
      "reward_description": "$50 Amazon Gift Card",

      // Computed convenience fields
      "goal": 2000  // ← Same as target_value, for frontend convenience
    },
    {
      // Raffle example
      "id": "mission-uuid-5",
      "mission_type": "raffle",
      "display_name": "VIP Raffle",
      "description": "Enter to win iPhone 16 Pro",  // ← Backend interpolates prize_name
      "target_value": 0,
      "tier_eligibility": "tier_3",
      "raffle_prize_name": "iPhone 16 Pro",
      "raffle_end_date": "2025-02-15T23:59:59Z",
      "activated": true,
      "enabled": true,
      "required_tier": null,

      // Progress data (NULL if user hasn't participated yet)
      "current_progress": 0,
      "progress_percentage": 0,
      "remaining_value": 0,
      "status": "available",  // ← Backend computed: activated=true, no progress record
      "checkpoint_end": null,  // ← Raffles don't use checkpoint deadlines

      // Reward data
      "reward_type": "gift",
      "reward_value": null,
      "reward_custom_text": "iPhone 16 Pro",
      "reward_description": "iPhone 16 Pro - Latest Model",

      "goal": 1
    },
    {
      // Locked mission example (preview visibility)
      "id": "mission-uuid-8",
      "mission_type": "sales",
      "display_name": "Elite Payday",
      "description": "Reach elite sales target",
      "target_value": 5000,
      "tier_eligibility": "tier_4",  // Platinum only
      "raffle_prize_name": null,
      "raffle_end_date": null,
      "activated": false,
      "enabled": true,
      "required_tier": "Platinum",  // ← Backend sets this because user.tier != tier_eligibility

      // Progress data (NULL for locked missions)
      "current_progress": 0,
      "progress_percentage": 0,
      "remaining_value": 5000,
      "status": "locked",  // ← Backend computed virtual status
      "checkpoint_end": null,

      // Reward data
      "reward_type": "gift_card",
      "reward_value": 100,
      "reward_custom_text": null,
      "reward_description": "$100 Amazon Gift Card",

      "goal": 5000
    }
  ]
}
```

---

## Status Computation Logic

### Backend Computes Virtual Statuses

```typescript
// Backend pseudocode for status computation
function computeMissionStatus(mission, progress, user) {
  // 1. Check if user is eligible
  if (mission.tier_eligibility !== user.current_tier && mission.tier_eligibility !== 'all') {
    return 'locked';
  }

  // 2. Raffle-specific statuses
  if (mission.mission_type === 'raffle') {
    if (!progress) {
      // No progress record means user hasn't participated
      return mission.activated ? 'available' : 'dormant';
    }
    // Has progress record
    return progress.status; // 'processing', 'won', 'lost', 'fulfilled'
  }

  // 3. Regular mission statuses
  if (!progress) {
    return 'active'; // Mission just unlocked
  }

  return progress.status; // 'active', 'completed', 'claimed', 'fulfilled', 'cancelled'
}
```

### Status Types

| Status | Source | Meaning |
|--------|--------|---------|
| **Database Statuses** (from `mission_progress.status`) |
| `active` | DB | In progress |
| `completed` | DB | Target reached, can claim |
| `claimed` | DB | Reward claimed, pending fulfillment |
| `fulfilled` | DB | Admin fulfilled (filtered out from this endpoint) |
| `cancelled` | DB | Mission disabled (filtered out from this endpoint) |
| `processing` | DB | Raffle entry submitted |
| `won` | DB | Raffle winner |
| `lost` | DB | Raffle loser (filtered out from this endpoint) |
| **Computed Statuses** (computed by backend) |
| `available` | Computed | Raffle: `activated=true` AND no progress record |
| `dormant` | Computed | Raffle: `activated=false` AND no progress record |
| `locked` | Computed | User's tier doesn't match `tier_eligibility` |

---

## Filtering Logic

### Missions to Include

```typescript
// Backend filters BEFORE sending to frontend
missions.filter(m => {
  // 1. Exclude disabled missions
  if (!m.enabled) return false;

  // 2. Exclude fulfilled missions (those go to history endpoint)
  if (progress?.status === 'fulfilled') return false;

  // 3. Exclude lost raffle entries (those go to history endpoint)
  if (progress?.status === 'lost') return false;

  // 4. Exclude cancelled missions
  if (progress?.status === 'cancelled') return false;

  // 5. Include if eligible, 'all' tier, or within preview range
  return (
    m.tier_eligibility === user.current_tier ||
    m.tier_eligibility === 'all' ||
    (m.preview_from_tier && userTierLevel >= previewTierLevel)
  );
});
```

---

## Hardcoded Display Name Mapping

### Backend Implementation

```typescript
// lib/missions.ts
export const MISSION_DISPLAY_NAMES: Record<string, { name: string; description: string }> = {
  'sales': {
    name: 'Unlock Payday',
    description: 'Reach your sales target'
  },
  'videos': {
    name: 'Lights, Camera, Go!',
    description: 'Film and post new clips'
  },
  'likes': {
    name: 'Road to Viral',
    description: 'Rack up those likes'
  },
  'views': {
    name: 'Eyes on You',
    description: 'Boost your total views'
  },
  'raffle': {
    name: 'VIP Raffle',
    description: 'Enter to win {prize_name}'  // ← Interpolate raffle_prize_name
  }
};

export function getMissionDisplayName(mission: Mission): { name: string; description: string } {
  const display = MISSION_DISPLAY_NAMES[mission.mission_type];

  if (mission.mission_type === 'raffle' && mission.raffle_prize_name) {
    return {
      name: display.name,
      description: display.description.replace('{prize_name}', mission.raffle_prize_name)
    };
  }

  return display;
}
```

---

## Value Extraction from JSONB

### Backend Implementation

```typescript
// Extract reward values from benefits.value_data JSONB
function extractRewardValue(benefit: Benefit) {
  if (!benefit.value_data) return null;

  const data = JSON.parse(benefit.value_data);

  switch (benefit.type) {
    case 'gift_card':
    case 'spark_ads':
      return data.amount;  // e.g., {"amount": 50}

    case 'commission_boost':
    case 'discount':
      return data.percent;  // e.g., {"percent": 5, "duration_days": 30}

    case 'physical_gift':
    case 'experience':
      return null;  // These use description TEXT instead

    default:
      return null;
  }
}
```

---

## Frontend Expectations

### What Frontend Receives

Frontend expects a **flattened object** combining:
- Mission template data
- User progress data
- Benefit/reward data
- Computed convenience fields

### What Frontend Does NOT Need to Do

❌ Join tables
❌ Compute virtual statuses
❌ Filter by `enabled` or tier eligibility
❌ Extract JSONB values
❌ Look up hardcoded display names

### What Frontend DOES Need to Do

✅ Display missions using provided data
✅ Sort by status priority (already sorted by backend, but can re-sort if needed)
✅ Format currency/numbers for display
✅ Calculate days remaining from `raffle_end_date`
✅ Show appropriate UI for each status

---

## Other Endpoints

### GET /api/missions/history - Completed Missions

Returns missions with `status IN ('fulfilled', 'lost')`.

### POST /api/missions/:id/claim - Claim Regular Mission

Transitions status from `completed` → `claimed`.

### POST /api/missions/:id/participate - Participate in Raffle

Creates `mission_progress` (status='processing'), `raffle_participants`, and `redemptions` records.

---

## Summary

**Key Takeaway:** The `checkpoint_end` field in frontend mock data comes from `mission_progress.checkpoint_end`, NOT from the `missions` table. The backend API must join these tables and return a flattened response structure for frontend consumption.
