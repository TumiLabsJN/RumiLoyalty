"use client"
    import {
      Trophy,
      CheckCircle2,
      ChevronRight,
      TrendingUp,
      Video,
      Heart,
      Eye,
      Ticket,
      Lock,
      Loader2,
    } from "lucide-react"
    import { Button } from "@/components/ui/button"
    import { PageLayout } from "@/components/pagelayout"
    import { cn } from "@/lib/utils"
    import Link from "next/link"

    export default function MissionsPage() {
      const currentTier = "Gold" // Current VIP level (dynamic from backend)
      const completedMissions = 12 // Total completed missions count (dynamic from backend)

      // Tier colors (matches VIP level)
      const tierColors = {
        Bronze: "#CD7F32",
        Silver: "#94a3b8",
        Gold: "#F59E0B",
        Platinum: "#818CF8",
      }

      const currentTierColor = tierColors[currentTier as keyof typeof tierColors]

      const handleClaimMission = (missionId: string) => {
        console.log("[v0] Claim mission clicked:", missionId)
        // TODO: POST /api/missions/:id/claim
        // Sets status from 'completed' â†’ 'claimed'
      }

      const handleParticipateRaffle = (missionId: string) => {
        console.log("[v0] Participate in raffle clicked:", missionId)
        // TODO: POST /api/missions/:id/participate
        // Creates mission_progress (status='processing'), raffle_participants, redemptions
      }

      // Map backend mission types to frontend icons
      const getIconForMissionType = (missionType: string, status: string) => {
        if (status === "locked") {
          return <Lock className="h-8 w-8 text-slate-400" />
        }

        const iconClass = cn(
          "h-8 w-8",
          status === "processing" && "text-amber-500",
          (status === "active" || status === "available" || status === "dormant") &&
  "text-slate-700",
          (status === "completed" || status === "claimed" || status === "won") &&
  "text-green-600",
        )

        // Backend mission_type â†’ Frontend icon mapping
        switch (missionType) {
          case "sales":
            return <TrendingUp className={iconClass} />
          case "videos":
            return <Video className={iconClass} />
          case "likes":
            return <Heart className={iconClass} />
          case "views":
            return <Eye className={iconClass} />
          case "raffle":
            return <Ticket className={iconClass} />
          default:
            return <TrendingUp className={iconClass} />
        }
      }

      // Calculate days remaining
      const calculateDaysRemaining = (endDate: string): number => {
        return Math.ceil((new Date(endDate).getTime() - Date.now()) / (1000 * 60 * 60 * 24))
      }

      // Format remaining amount text based on mission type
      const getRemainingText = (missionType: string, remainingValue: number): string => {
        switch (missionType) {
          case "sales":
            return `$${remainingValue.toLocaleString()} more to sell!`
          case "videos":
            return `${remainingValue} more ${remainingValue === 1 ? 'video' : 'videos'} to
  post!`
          case "likes":
            return `${remainingValue.toLocaleString()} more likes!`
          case "views":
            return `${remainingValue.toLocaleString()} more views!`
          default:
            return `${remainingValue} more!`
        }
      }

      // Format reward text based on reward type
      const getRewardText = (
        rewardType: string,
        rewardValue: number | null,
        rewardCustomText: string | null
      ): string => {
        switch (rewardType) {
          case "gift_card":
            return `Win a $${rewardValue} Gift Card!`
          case "commission_boost":
            return `Win a ${rewardValue}% Commission Boost!`
          case "discount":
            return `Win a ${rewardValue}% Follower Discount!`
          case "gift":
            return `Win a ${rewardCustomText} Gift!`
          case "trip":
            return `Win a ${rewardCustomText}!`
          default:
            return "Win a reward!"
        }
      }

      /**
       * All missions from backend API (GET /api/missions)
       * Backend sends unsorted data - frontend handles filtering and sorting
       *
       * DYNAMIC FIELDS (from backend):
       * - mission_type: Backend mission type identifier (sales/videos/likes/views/raffle)
       * - display_name: Mission title (DYNAMIC for regular missions, HARDCODED "VIP Raffle"
  for raffles)
       * - description: Mission description (MISSION_SALES, MISSION_VIDEOS, etc. from backend)
       * - current_progress: Current value achieved (e.g., 1500, 10, 500)
       * - goal: Target value to complete mission (e.g., 2000, 15, 1000)
       * - progress_percentage: Calculated % complete (dynamic from backend)
       * - remaining_value: How much more needed to complete (JUST THE NUMBER, e.g., 500, 5,
  100, 2420)
       * - reward_type: Backend reward type (gift_card, commission_boost, discount, gift, trip)
       * - reward_value: Numeric value for gift_card, commission_boost, discount (null for
  gift/trip)
       * - reward_custom_text: Custom text for gift/trip rewards (15 char limit, null for
  others)
       * - status: COMPUTED BY BACKEND (see detailed breakdown below)
       * - checkpoint_end: Deadline for regular missions (ISO timestamp)
       * - required_tier: Tier needed to unlock (null if not locked)
       * - raffle_prize_name: For raffle type only (15 char limit, dynamic from backend)
       * - raffle_end_date: For raffle type only (ISO timestamp)
       * - activated: For raffle type only (boolean - if raffle is accepting entries)
       * - enabled: Master visibility switch (if false, mission should not appear in UI)
       *
       * STATUS FIELD - Computed by Backend API:
       * Backend computes status from missions.activated + mission_progress.status
       *
       * Regular Missions (sales/videos/views/likes):
       *   'active': User has progress record with status='active'
       *   'completed': User has progress record with status='completed'
       *   'claimed': User has progress record with status='claimed'
       *   'cancelled': User had progress but mission was disabled by admin (should be filtered out)
       *   (fulfilled/lost are filtered out - move to Completed Missions tab)
       *
       * Raffle Missions:
       *   'dormant': missions.activated=false AND enabled=true, no progress record (shows "Raffle starts soon")
       *   'available': missions.activated=true AND enabled=true, no progress record (shows [Participate] button)
       *   'processing': User has progress record with status='processing' (waiting for draw)
       *   'won': User has progress record with status='won' (winner selected)
       *   (lost/fulfilled are filtered out - move to Completed Missions tab)
       *
       * Cross-Mission:
       *   'locked': User's tier doesn't match mission.tier_eligibility (shows ðŸ”’ badge)
       *
       * VISIBILITY CONTROL (missions.enabled field):
       *   enabled=false â†’ Mission completely hidden from UI (overrides all statuses including activated)
       *   enabled=true, activated=false â†’ Raffle dormant (visible but not accepting entries)
       *   enabled=true, activated=true â†’ Raffle available (accepting entries)
       *
       * KEY INSIGHT: 'dormant' and 'available' are NOT stored in database - they are
       * computed by backend from the missions.activated + missions.enabled fields + absence of progress record.
       */
      const missions = [
        {
          id: "1",
          mission_type: "sales",
          display_name: "Unlock Payday",
          description: "Reach your sales target",
          current_progress: 1500,
          goal: 2000,
          progress_percentage: 75,
          remaining_value: 500,
          reward_type: "gift_card",
          reward_value: 50,
          reward_custom_text: null,
          status: "active" as const,
          checkpoint_end: "2025-03-15T23:59:59Z",
          required_tier: null,
          raffle_prize_name: null,
          raffle_end_date: null,
          activated: null,
          enabled: true,
        },
        {
          id: "2",
          mission_type: "videos",
          display_name: "Lights, Camera, Go!",
          description: "Film and post new clips",
          current_progress: 15,
          goal: 15,
          progress_percentage: 100,
          remaining_value: 0,
          reward_type: "commission_boost",
          reward_value: 5,
          reward_custom_text: null,
          status: "completed" as const,
          checkpoint_end: "2025-03-10T23:59:59Z",
          required_tier: null,
          raffle_prize_name: null,
          raffle_end_date: null,
          activated: null,
          enabled: true,
        },
        {
          id: "3",
          mission_type: "likes",
          display_name: "Road to Viral",
          description: "Rack up those likes",
          current_progress: 1000,
          goal: 1000,
          progress_percentage: 100,
          remaining_value: 0,
          reward_type: "gift_card",
          reward_value: 25,
          reward_custom_text: null,
          status: "claimed" as const,
          checkpoint_end: "2025-02-28T23:59:59Z",
          required_tier: null,
          raffle_prize_name: null,
          raffle_end_date: null,
          activated: null,
          enabled: true,
        },
        {
          id: "4",
          mission_type: "views",
          display_name: "Eyes on You",
          description: "Boost your total views",
          current_progress: 25000,
          goal: 50000,
          progress_percentage: 50,
          remaining_value: 25000,
          reward_type: "commission_boost",
          reward_value: 10,
          reward_custom_text: null,
          status: "active" as const,
          checkpoint_end: "2025-03-20T23:59:59Z",
          required_tier: null,
          raffle_prize_name: null,
          raffle_end_date: null,
          activated: null,
          enabled: true,
        },
        {
          id: "5",
          mission_type: "raffle",
          display_name: "VIP Raffle",
          description: "",
          current_progress: 0,
          goal: 1,
          progress_percentage: 0,
          remaining_value: 0,
          reward_type: "gift",
          reward_value: null,
          reward_custom_text: "iPhone 16 Pro",
          status: "available" as const,
          checkpoint_end: null,
          required_tier: null,
          raffle_prize_name: "iPhone 16 Pro",
          raffle_end_date: "2025-02-15T23:59:59Z",
          activated: true,
          enabled: true,
        },
        {
          id: "6",
          mission_type: "raffle",
          display_name: "VIP Raffle",
          description: "",
          current_progress: 0,
          goal: 1,
          progress_percentage: 0,
          remaining_value: 0,
          reward_type: "gift",
          reward_value: null,
          reward_custom_text: "AirPods Pro",
          status: "processing" as const,
          checkpoint_end: null,
          required_tier: null,
          raffle_prize_name: "AirPods Pro",
          raffle_end_date: "2025-03-01T23:59:59Z",
          activated: true,
          enabled: true,
        },
        {
          id: "7",
          mission_type: "raffle",
          display_name: "VIP Raffle",
          description: "",
          current_progress: 0,
          goal: 1,
          progress_percentage: 0,
          remaining_value: 0,
          reward_type: "gift",
          reward_value: null,
          reward_custom_text: "iPhone 18",
          status: "won" as const,
          checkpoint_end: null,
          required_tier: null,
          raffle_prize_name: "PLASMA TEEWEE",
          raffle_end_date: null,
          activated: true,
          enabled: true,
        },
        {
          id: "8",
          mission_type: "raffle",
          display_name: "VIP Raffle",
          description: "",
          current_progress: 0,
          goal: 1,
          progress_percentage: 0,
          remaining_value: 0,
          reward_type: "gift",
          reward_value: null,
          reward_custom_text: "MacBook Pro",
          status: "locked" as const,
          checkpoint_end: null,
          required_tier: "Platinum",
          raffle_prize_name: "MacBook Pro",
          raffle_end_date: null,
          activated: false,
          enabled: true,
        },
        {
          id: "9",
          mission_type: "raffle",
          display_name: "VIP Raffle",
          description: "",
          current_progress: 0,
          goal: 1,
          progress_percentage: 0,
          remaining_value: 0,
          reward_type: "trip",
          reward_value: null,
          reward_custom_text: "iPad Pro",
          status: "dormant" as const,
          checkpoint_end: null,
          required_tier: null,
          raffle_prize_name: "iPad Pro",
          raffle_end_date: "2025-04-01T23:59:59Z",
          activated: false,
          enabled: true,
        },
      ]

      // Frontend filtering and sorting logic
      const displayMissions = missions
        .filter((mission) => {
          // Filter out missions that should not appear in Available Missions tab
          // 1. Fulfilled missions (moved to Completed Missions tab)
          if (mission.status === "fulfilled") return false

          // 2. Lost raffle entries (moved to Completed Missions tab)
          if (mission.status === "lost") return false

          // 3. Cancelled missions (admin disabled mission mid-progress)
          if (mission.status === "cancelled") return false

          // 4. Disabled missions (admin set enabled=false - master visibility switch)
          // This overrides all other states including activated
          if (mission.enabled === false) return false

          // All other statuses should appear (active, completed, claimed, processing, won, available, dormant, locked)
          return true
        })
        .sort((a, b) => {
          const statusPriority = {
            won: 1,
            completed: 2,
            claimed: 3,
            processing: 4,
            active: 5,
            available: 6,
            dormant: 7,
            locked: 8,
          }
          return statusPriority[a.status] - statusPriority[b.status]
        })

      return (
        <PageLayout
          title="Missions"
          headerContent={
            <div className="inline-flex items-center gap-2 bg-white/20 backdrop-blur-sm px-3
  py-2 rounded-lg border border-white/30">
              <Trophy className="w-5 h-5" style={{ color: currentTierColor }} />
              <span className="text-base font-semibold text-white">{currentTier}</span>
            </div>
          }
        >
          {/* Mission Cards */}
          <div className="space-y-4">
            {displayMissions.map((mission) => {
              const isRaffle = mission.mission_type === "raffle"

              // Build reward text
              let rewardText = ""
              if (isRaffle) {
                // For raffles, use raffle_prize_name
                if (mission.status === "won") {
                  rewardText = `You won ${mission.raffle_prize_name}!`
                } else if (mission.status === "available" || mission.status === "processing") {
                  rewardText = getRewardText(mission.reward_type, mission.reward_value,
  mission.raffle_prize_name)
                }
              } else {
                // For regular missions, use reward fields
                rewardText = getRewardText(mission.reward_type, mission.reward_value,
  mission.reward_custom_text)
              }

              // Build mission description for special raffle states
              let missionDescription = mission.description
              if (isRaffle) {
                if (mission.status === "locked") {
                  missionDescription = `Unlock at ${mission.required_tier}`
                } else if (mission.status === "dormant") {
                  missionDescription = "Raffle starts soon"
                } else if (mission.status === "processing") {
                  const days = calculateDaysRemaining(mission.raffle_end_date!)
                  missionDescription = `${days} days until raffle`
                }
              }

              // Card styling based on status
              const cardClass = cn(
                "p-5 rounded-xl border",
                (mission.status === "active" || mission.status === "available" ||
  mission.status === "dormant") &&
                  "bg-slate-50 border-slate-200",
                mission.status === "processing" && "bg-amber-50 border-amber-200",
                (mission.status === "completed" || mission.status === "claimed" ||
  mission.status === "won") &&
                  "bg-green-50 border-green-200",
                mission.status === "locked" && "bg-slate-50 border-slate-200 opacity-60",
              )

              return (
                <div key={mission.id} className={cardClass}>
                  {/* Top Row: Icon + Locked Badge */}
                  <div className="flex items-start justify-between mb-3">
                    {getIconForMissionType(mission.mission_type, mission.status)}

                    {/* Locked badge */}
                    {mission.status === "locked" && (
                      <div className="bg-slate-100 text-slate-500 px-3 py-1.5 rounded-full
  text-xs font-medium">
                        ðŸ”’ {mission.required_tier}
                      </div>
                    )}
                  </div>

                  {/* Mission Title */}
                  <h3 className="text-lg font-bold text-slate-900
  mb-2">{mission.display_name}</h3>

                  {/* Reward Text - Shows for all non-locked, non-dormant missions */}
                  {mission.status !== "locked" && mission.status !== "dormant" && rewardText &&
   (
                    <p className="text-base text-slate-600 mb-3 font-medium">{rewardText}</p>
                  )}

                  {/* Mission Description - Only for locked/dormant raffles */}
                  {(mission.status === "locked" || mission.status === "dormant") && (
                    <p className="text-base text-slate-600 mb-3">{missionDescription}</p>
                  )}

                  {/* Progress Section (only for active/completed regular missions) */}
                  {!isRaffle && (mission.status === "active" || mission.status === "completed")
   && (
                    <>
                      {/* Progress Bar */}
                      <div className="mb-3">
                        <div className="flex items-center justify-between mb-2">
                          <div className="w-full bg-slate-200 rounded-full h-3 mr-3">
                            <div
                              className="bg-blue-600 h-3 rounded-full transition-all
  duration-500"
                              style={{ width: `${mission.progress_percentage}%` }}
                            />
                          </div>
                          <span className="text-base font-semibold text-slate-900
  whitespace-nowrap">
                            {mission.progress_percentage}%
                          </span>
                        </div>
                      </div>

                      {/* Remaining Amount Text - Only for active missions */}
                      {mission.remaining_value > 0 && mission.status === "active" && (
                        <p className="text-base font-semibold text-slate-900 mb-3">
                          {getRemainingText(mission.mission_type, mission.remaining_value)}
                        </p>
                      )}
                    </>
                  )}

                  {/* Processing raffle description */}
                  {isRaffle && mission.status === "processing" && (
                    <p className="text-sm text-slate-600 mb-3">{missionDescription}</p>
                  )}

                  {/* Status-specific actions/displays */}
                  {mission.status === "completed" && !isRaffle && (
                    <Button
                      onClick={() => handleClaimMission(mission.id)}
                      className="w-full bg-gradient-to-r from-green-500 to-green-600
  hover:from-green-600 hover:to-green-700 text-white font-semibold py-3 rounded-lg"
                    >
                      Claim Reward
                    </Button>
                  )}

                  {mission.status === "claimed" && (
                    <div className="flex items-center gap-2 bg-green-100 text-green-700 px-3
  py-2 rounded-lg text-sm font-medium w-fit">
                      <Loader2 className="h-4 w-4 animate-spin" />
                      Prize on the way
                    </div>
                  )}

                  {isRaffle && mission.status === "available" && (
                    <Button
                      onClick={() => handleParticipateRaffle(mission.id)}
                      className="w-full bg-gradient-to-r from-purple-500 to-purple-600
  hover:from-purple-600 hover:to-purple-700 text-white font-semibold py-3 rounded-lg"
                    >
                      Participate
                    </Button>
                  )}

                  {isRaffle && mission.status === "processing" && (
                    <div className="flex items-center gap-2 bg-amber-100 text-amber-700 px-3
  py-2 rounded-lg text-sm font-medium w-fit">
                      <Ticket className="h-4 w-4" />
                      Waiting for Draw
                    </div>
                  )}

                  {isRaffle && mission.status === "won" && (
                    <div className="flex items-center gap-2 bg-green-100 text-green-700 px-3
  py-2 rounded-lg text-sm font-medium w-fit">
                      <Loader2 className="h-4 w-4 animate-spin" />
                      Prize on the way
                    </div>
                  )}
                </div>
              )
            })}
          </div>

          {/* Completed Missions History Section */}
          <div className="border-t border-slate-200 pt-6 mt-8">
            <Link href="/missions/missionhistory" className="block">
              <Button
                variant="outline"
                className="w-full bg-white border-slate-200 text-slate-700 font-medium py-3
  rounded-lg hover:bg-slate-50 flex items-center justify-between"
              >
                <div className="flex items-center gap-2">
                  <CheckCircle2 className="h-4 w-4 text-slate-500" />
                  <span>View Completed Missions</span>
                  <span className="text-slate-400">({completedMissions})</span>
                </div>
                <ChevronRight className="h-4 w-4 text-slate-400" />
              </Button>
            </Link>
          </div>
        </PageLayout>
      )
    }
