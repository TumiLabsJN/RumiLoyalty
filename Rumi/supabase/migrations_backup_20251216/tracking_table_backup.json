[
  {
    "version": "20251128173733",
    "name": "initial_schema",
    "statements": [
      "-- =============================================\n-- RUMI LOYALTY PLATFORM - INITIAL SCHEMA\n-- Generated from SchemaFinalv2.md\n-- =============================================\n\n-- Note: SchemaFinalv2.md uses VARCHAR(50) with CHECK constraints\n-- instead of PostgreSQL ENUMs for flexibility during MVP phase.\n-- CHECK constraints will be added per-table in subsequent tasks.\n\n-- =============================================\n-- 1.1 clients Table\n-- Multi-tenant configuration (single client for MVP, scalable to multiple)\n-- Reference: SchemaFinalv2.md lines 106-120\n-- =============================================\n\nCREATE TABLE clients (\n    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),\n    name VARCHAR(255) NOT NULL,\n    subdomain VARCHAR(100) UNIQUE,\n    logo_url TEXT,\n    primary_color VARCHAR(7) DEFAULT '#6366f1',\n    tier_calculation_mode VARCHAR(50) DEFAULT 'fixed_checkpoint'\n        CHECK (tier_calculation_mode IN ('fixed_checkpoint', 'lifetime')),\n    checkpoint_months INTEGER DEFAULT 4,\n    vip_metric VARCHAR(10) NOT NULL DEFAULT 'units'\n        CHECK (vip_metric IN ('units', 'sales')),\n    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),\n    updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()\n)",
      "-- =============================================\n-- 1.6 tiers Table\n-- Dynamic tier configuration (3-6 tiers per client, admin-customizable)\n-- Reference: SchemaFinalv2.md lines 250-268\n-- =============================================\n\nCREATE TABLE tiers (\n    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),\n    client_id UUID NOT NULL REFERENCES clients(id),\n    tier_order INTEGER NOT NULL,\n    tier_id VARCHAR(50) NOT NULL,\n    tier_name VARCHAR(100) NOT NULL,\n    tier_color VARCHAR(7) NOT NULL,\n    sales_threshold DECIMAL(10, 2),\n    units_threshold INTEGER,\n    commission_rate DECIMAL(5, 2) NOT NULL,\n    checkpoint_exempt BOOLEAN DEFAULT false,\n    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),\n    updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),\n    UNIQUE(client_id, tier_order),\n    UNIQUE(client_id, tier_id)\n)",
      "-- =============================================\n-- 1.2 users Table\n-- Content creator profiles and performance tracking\n-- Reference: SchemaFinalv2.md lines 123-155\n-- Note: 16 precomputed fields added in Task 1.1.5a\n-- =============================================\n\nCREATE TABLE users (\n    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),\n    client_id UUID NOT NULL REFERENCES clients(id),\n    tiktok_handle VARCHAR(100) NOT NULL,\n    email VARCHAR(255),\n    email_verified BOOLEAN DEFAULT false,\n    password_hash VARCHAR(255) NOT NULL,\n    terms_accepted_at TIMESTAMP WITH TIME ZONE,\n    terms_version VARCHAR(50),\n    is_admin BOOLEAN DEFAULT false,\n    current_tier VARCHAR(50) DEFAULT 'tier_1',\n    tier_achieved_at TIMESTAMP WITH TIME ZONE,\n    next_checkpoint_at TIMESTAMP WITH TIME ZONE,\n    checkpoint_sales_target DECIMAL(10, 2),\n    checkpoint_units_target INTEGER,\n    -- Payment info fields (3 fields)\n    default_payment_method VARCHAR(20)\n        CHECK (default_payment_method IN ('paypal', 'venmo')),\n    default_payment_account VARCHAR(255),\n    payment_info_updated_at TIMESTAMP WITH TIME ZONE,\n    -- Precomputed fields: Leaderboard (5 fields)\n    leaderboard_rank INTEGER,\n    total_sales DECIMAL(10, 2),\n    total_units INTEGER,\n    manual_adjustments_total DECIMAL(10, 2),\n    manual_adjustments_units INTEGER,\n    -- Precomputed fields: Checkpoint progress (3 fields)\n    checkpoint_sales_current DECIMAL(10, 2),\n    checkpoint_units_current INTEGER,\n    projected_tier_at_checkpoint UUID,\n    -- Precomputed fields: Engagement (4 fields)\n    checkpoint_videos_posted INTEGER,\n    checkpoint_total_views BIGINT,\n    checkpoint_total_likes BIGINT,\n    checkpoint_total_comments BIGINT,\n    -- Precomputed fields: Next tier (3 fields)\n    next_tier_name VARCHAR(100),\n    next_tier_threshold DECIMAL(10, 2),\n    next_tier_threshold_units INTEGER,\n    -- Precomputed fields: Historical (1 field)\n    checkpoint_progress_updated_at TIMESTAMP WITH TIME ZONE,\n    -- Other fields\n    first_video_date TIMESTAMP WITH TIME ZONE,\n    last_login_at TIMESTAMP WITH TIME ZONE,\n    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),\n    updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()\n)",
      "-- =============================================\n-- 1.3 otp_codes Table\n-- Email verification via one-time passwords during signup\n-- Reference: SchemaFinalv2.md lines 158-176\n-- =============================================\n\nCREATE TABLE otp_codes (\n    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),\n    user_id UUID REFERENCES users(id) ON DELETE CASCADE,\n    session_id VARCHAR(100) NOT NULL UNIQUE,\n    code_hash VARCHAR(255) NOT NULL,\n    expires_at TIMESTAMP WITH TIME ZONE NOT NULL,\n    attempts INTEGER DEFAULT 0,\n    used BOOLEAN DEFAULT false,\n    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()\n)",
      "CREATE INDEX idx_otp_session ON otp_codes(session_id)",
      "CREATE INDEX idx_otp_expires ON otp_codes(expires_at)",
      "-- =============================================\n-- 1.4 password_reset_tokens Table\n-- Secure password reset via email magic links\n-- Reference: SchemaFinalv2.md lines 187-219\n-- =============================================\n\nCREATE TABLE password_reset_tokens (\n    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),\n    user_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,\n    token_hash VARCHAR(255) NOT NULL,\n    created_at TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT NOW(),\n    expires_at TIMESTAMP WITH TIME ZONE NOT NULL,\n    used_at TIMESTAMP WITH TIME ZONE,\n    ip_address VARCHAR(45)\n)",
      "CREATE INDEX idx_password_reset_token_hash ON password_reset_tokens(token_hash)",
      "CREATE INDEX idx_password_reset_user_id ON password_reset_tokens(user_id)",
      "CREATE INDEX idx_password_reset_expires_at ON password_reset_tokens(expires_at)",
      "-- =============================================\n-- 1.5 videos Table\n-- Per-video analytics from Cruva CSV (videos.csv)\n-- Reference: SchemaFinalv2.md lines 223-247\n-- =============================================\n\nCREATE TABLE videos (\n    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),\n    user_id UUID REFERENCES users(id),\n    client_id UUID NOT NULL REFERENCES clients(id),\n    video_url TEXT UNIQUE NOT NULL,\n    video_title TEXT,\n    post_date DATE NOT NULL,\n    views INTEGER DEFAULT 0,\n    likes INTEGER DEFAULT 0,\n    comments INTEGER DEFAULT 0,\n    gmv DECIMAL(10, 2) DEFAULT 0,\n    ctr DECIMAL(5, 2),\n    units_sold INTEGER DEFAULT 0,\n    sync_date TIMESTAMP WITH TIME ZONE NOT NULL,\n    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),\n    updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()\n)",
      "-- =============================================\n-- 1.7 sales_adjustments Table\n-- Manual sales corrections (offline sales, refunds, bonuses)\n-- Reference: SchemaFinalv2.md lines 271-286\n-- =============================================\n\nCREATE TABLE sales_adjustments (\n    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),\n    user_id UUID REFERENCES users(id),\n    client_id UUID NOT NULL REFERENCES clients(id),\n    amount DECIMAL(10, 2),\n    amount_units INTEGER,\n    reason TEXT NOT NULL,\n    adjustment_type VARCHAR(50) NOT NULL\n        CHECK (adjustment_type IN ('manual_sale', 'refund', 'bonus', 'correction')),\n    adjusted_by UUID REFERENCES users(id),\n    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),\n    applied_at TIMESTAMP WITH TIME ZONE\n)",
      "-- =============================================\n-- 1.8 tier_checkpoints Table\n-- Audit trail for tier maintenance evaluations\n-- Reference: SchemaFinalv2.md lines 289-308\n-- =============================================\n\nCREATE TABLE tier_checkpoints (\n    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),\n    user_id UUID REFERENCES users(id),\n    client_id UUID NOT NULL REFERENCES clients(id),\n    checkpoint_date TIMESTAMP WITH TIME ZONE NOT NULL,\n    period_start_date TIMESTAMP WITH TIME ZONE NOT NULL,\n    period_end_date TIMESTAMP WITH TIME ZONE NOT NULL,\n    sales_in_period DECIMAL(10, 2),\n    sales_required DECIMAL(10, 2),\n    units_in_period INTEGER,\n    units_required INTEGER,\n    tier_before VARCHAR(50) NOT NULL,\n    tier_after VARCHAR(50) NOT NULL,\n    status VARCHAR(50) NOT NULL\n        CHECK (status IN ('maintained', 'promoted', 'demoted')),\n    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()\n)",
      "-- =============================================\n-- 1.9 handle_changes Table\n-- Audit trail for TikTok handle changes\n-- Reference: SchemaFinalv2.md lines 311-325\n-- =============================================\n\nCREATE TABLE handle_changes (\n    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),\n    user_id UUID REFERENCES users(id),\n    old_handle VARCHAR(100) NOT NULL,\n    new_handle VARCHAR(100) NOT NULL,\n    detected_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),\n    resolved_by UUID REFERENCES users(id),\n    resolved_at TIMESTAMP WITH TIME ZONE\n)",
      "-- =============================================\n-- 1.10 sync_logs Table\n-- Track automated and manual data sync operations from Cruva\n-- Reference: SchemaFinalv2.md lines 328-352\n-- =============================================\n\nCREATE TABLE sync_logs (\n    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),\n    client_id UUID NOT NULL REFERENCES clients(id),\n    status VARCHAR(50) NOT NULL DEFAULT 'running'\n        CHECK (status IN ('running', 'success', 'failed')),\n    source VARCHAR(50) NOT NULL DEFAULT 'auto'\n        CHECK (source IN ('auto', 'manual')),\n    started_at TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT NOW(),\n    completed_at TIMESTAMP WITH TIME ZONE,\n    records_processed INTEGER DEFAULT 0,\n    error_message TEXT,\n    file_name VARCHAR(255),\n    triggered_by UUID REFERENCES users(id),\n    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()\n)",
      "CREATE INDEX idx_sync_logs_client ON sync_logs(client_id)",
      "CREATE INDEX idx_sync_logs_status ON sync_logs(client_id, status)",
      "CREATE INDEX idx_sync_logs_recent ON sync_logs(client_id, started_at DESC)",
      "-- =============================================\n-- SECTION 2: Missions | Rewards | Reward Sub-states\n-- =============================================\n\n-- =============================================\n-- 3. rewards Table (created before missions for FK dependency)\n-- Admin-configured reward templates\n-- Reference: SchemaFinalv2.md lines 458-586\n-- =============================================\n\nCREATE TABLE rewards (\n    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),\n    client_id UUID REFERENCES clients(id) ON DELETE CASCADE,\n    type VARCHAR(100) NOT NULL\n        CHECK (type IN ('gift_card', 'commission_boost', 'spark_ads', 'discount', 'physical_gift', 'experience')),\n    name VARCHAR(255),\n    description VARCHAR(12),\n    value_data JSONB,\n    reward_source VARCHAR(50) NOT NULL DEFAULT 'mission'\n        CHECK (reward_source IN ('vip_tier', 'mission')),\n    tier_eligibility VARCHAR(50) NOT NULL\n        CHECK (tier_eligibility IN ('tier_1', 'tier_2', 'tier_3', 'tier_4', 'tier_5', 'tier_6')),\n    enabled BOOLEAN DEFAULT false,\n    preview_from_tier VARCHAR(50)\n        CHECK (preview_from_tier IS NULL OR preview_from_tier IN ('tier_1', 'tier_2', 'tier_3', 'tier_4', 'tier_5', 'tier_6')),\n    redemption_frequency VARCHAR(50) DEFAULT 'unlimited'\n        CHECK (redemption_frequency IN ('one-time', 'monthly', 'weekly', 'unlimited')),\n    redemption_quantity INTEGER DEFAULT 1,\n    redemption_type VARCHAR(50) NOT NULL DEFAULT 'instant'\n        CHECK (redemption_type IN ('instant', 'scheduled')),\n    expires_days INTEGER,\n    display_order INTEGER,\n    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),\n    updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),\n    -- Constraint: quantity must be NULL for unlimited, 1-10 otherwise\n    CONSTRAINT check_quantity_with_frequency CHECK (\n        (redemption_frequency = 'unlimited' AND redemption_quantity IS NULL) OR\n        (redemption_frequency != 'unlimited' AND redemption_quantity >= 1 AND redemption_quantity <= 10)\n    ),\n    -- Constraint: discount type must have valid value_data\n    CONSTRAINT check_discount_value_data CHECK (\n        type != 'discount' OR (\n            value_data->>'percent' IS NOT NULL AND\n            (value_data->>'percent')::numeric BETWEEN 1 AND 100 AND\n            value_data->>'duration_minutes' IS NOT NULL AND\n            (value_data->>'duration_minutes')::integer BETWEEN 10 AND 525600 AND\n            value_data->>'coupon_code' IS NOT NULL AND\n            LENGTH(value_data->>'coupon_code') BETWEEN 2 AND 8 AND\n            value_data->>'coupon_code' ~ '^[A-Z0-9]+ AND\n            (value_data->>'max_uses' IS NULL OR (value_data->>'max_uses')::integer > 0)\n        )\n    )\n)",
      "CREATE INDEX idx_rewards_client ON rewards(client_id)",
      "CREATE INDEX idx_rewards_type ON rewards(type)",
      "CREATE INDEX idx_rewards_tier ON rewards(tier_eligibility)",
      "CREATE INDEX idx_rewards_source ON rewards(reward_source)",
      "CREATE INDEX idx_rewards_lookup ON rewards(client_id, enabled, tier_eligibility, reward_source, display_order)",
      "-- =============================================\n-- 1. missions Table\n-- Mission templates (goals/targets configured by admin)\n-- Reference: SchemaFinalv2.md lines 358-417\n-- =============================================\n\nCREATE TABLE missions (\n    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),\n    client_id UUID REFERENCES clients(id) ON DELETE CASCADE,\n    title VARCHAR(255) NOT NULL,\n    display_name VARCHAR(255) NOT NULL,\n    description TEXT,\n    mission_type VARCHAR(50) NOT NULL\n        CHECK (mission_type IN ('sales_dollars', 'sales_units', 'videos', 'views', 'likes', 'raffle')),\n    target_value INTEGER NOT NULL,\n    target_unit VARCHAR(20) NOT NULL DEFAULT 'dollars'\n        CHECK (target_unit IN ('dollars', 'units', 'count')),\n    reward_id UUID NOT NULL REFERENCES rewards(id),\n    tier_eligibility VARCHAR(50) NOT NULL\n        CHECK (tier_eligibility = 'all' OR tier_eligibility IN ('tier_1', 'tier_2', 'tier_3', 'tier_4', 'tier_5', 'tier_6')),\n    preview_from_tier VARCHAR(50)\n        CHECK (preview_from_tier IS NULL OR preview_from_tier IN ('tier_1', 'tier_2', 'tier_3', 'tier_4', 'tier_5', 'tier_6')),\n    display_order INTEGER NOT NULL,\n    raffle_end_date TIMESTAMP WITH TIME ZONE,\n    enabled BOOLEAN DEFAULT true,\n    activated BOOLEAN DEFAULT false,\n    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),\n    -- Constraint: raffle must have end date and target_value=0\n    CONSTRAINT check_raffle_requirements CHECK (\n        (mission_type != 'raffle') OR\n        (mission_type = 'raffle' AND raffle_end_date IS NOT NULL AND target_value = 0)\n    ),\n    -- Constraint: non-raffle must not have raffle_end_date\n    CONSTRAINT check_non_raffle_fields CHECK (\n        (mission_type = 'raffle') OR\n        (mission_type != 'raffle' AND raffle_end_date IS NULL)\n    ),\n    UNIQUE(client_id, tier_eligibility, mission_type, display_order)\n)",
      "CREATE INDEX idx_missions_client ON missions(client_id)",
      "CREATE INDEX idx_missions_tier ON missions(tier_eligibility)",
      "CREATE INDEX idx_missions_lookup ON missions(client_id, enabled, tier_eligibility, display_order)",
      "-- =============================================\n-- 2. mission_progress Table\n-- User progress on missions\n-- Reference: SchemaFinalv2.md lines 421-455\n-- =============================================\n\nCREATE TABLE mission_progress (\n    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),\n    user_id UUID REFERENCES users(id) ON DELETE CASCADE,\n    mission_id UUID REFERENCES missions(id) ON DELETE CASCADE,\n    client_id UUID NOT NULL REFERENCES clients(id),\n    current_value INTEGER DEFAULT 0,\n    status VARCHAR(50) DEFAULT 'active'\n        CHECK (status IN ('active', 'dormant', 'completed')),\n    completed_at TIMESTAMP WITH TIME ZONE,\n    checkpoint_start TIMESTAMP WITH TIME ZONE,\n    checkpoint_end TIMESTAMP WITH TIME ZONE,\n    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),\n    updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),\n    UNIQUE(user_id, mission_id, checkpoint_start)\n)",
      "CREATE INDEX idx_mission_progress_user ON mission_progress(user_id)",
      "CREATE INDEX idx_mission_progress_status ON mission_progress(status)",
      "CREATE INDEX idx_mission_progress_tenant ON mission_progress(client_id, user_id, status)",
      "-- =============================================\n-- 4. redemptions Table\n-- Tracks claims for both rewards AND missions (shared table)\n-- Reference: SchemaFinalv2.md lines 590-658\n-- =============================================\n\nCREATE TABLE redemptions (\n    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),\n    user_id UUID REFERENCES users(id) ON DELETE CASCADE,\n    reward_id UUID REFERENCES rewards(id) ON DELETE CASCADE,\n    mission_progress_id UUID REFERENCES mission_progress(id) ON DELETE CASCADE,\n    client_id UUID REFERENCES clients(id) ON DELETE CASCADE,\n    status VARCHAR(50) DEFAULT 'claimable'\n        CHECK (status IN ('claimable', 'claimed', 'fulfilled', 'concluded', 'rejected')),\n    tier_at_claim VARCHAR(50) NOT NULL,\n    redemption_type VARCHAR(50) NOT NULL\n        CHECK (redemption_type IN ('instant', 'scheduled')),\n    claimed_at TIMESTAMP WITH TIME ZONE,\n    scheduled_activation_date DATE,\n    scheduled_activation_time TIME,\n    activation_date TIMESTAMP WITH TIME ZONE,\n    expiration_date TIMESTAMP WITH TIME ZONE,\n    google_calendar_event_id VARCHAR(255),\n    fulfilled_at TIMESTAMP WITH TIME ZONE,\n    fulfilled_by UUID REFERENCES users(id),\n    fulfillment_notes TEXT,\n    concluded_at TIMESTAMP WITH TIME ZONE,\n    rejection_reason TEXT,\n    rejected_at TIMESTAMP WITH TIME ZONE,\n    external_transaction_id VARCHAR(255),\n    deleted_at TIMESTAMP WITH TIME ZONE,\n    deleted_reason VARCHAR(100),\n    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),\n    updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),\n    -- Composite unique for sub-state table FKs\n    UNIQUE(id, client_id)\n)",
      "-- Partial unique index for VIP tier rewards\nCREATE UNIQUE INDEX idx_redemptions_unique_vip ON redemptions(user_id, reward_id, tier_at_claim, claimed_at)\n    WHERE claimed_at IS NOT NULL",
      "-- Partial unique index for mission-based redemptions\nCREATE UNIQUE INDEX idx_redemptions_unique_mission ON redemptions(user_id, mission_progress_id)\n    WHERE mission_progress_id IS NOT NULL",
      "CREATE INDEX idx_redemptions_user ON redemptions(user_id)",
      "CREATE INDEX idx_redemptions_reward ON redemptions(reward_id)",
      "CREATE INDEX idx_redemptions_status ON redemptions(status)",
      "CREATE INDEX idx_redemptions_tenant ON redemptions(client_id, user_id, status)",
      "CREATE INDEX idx_redemptions_scheduled ON redemptions(scheduled_activation_date, scheduled_activation_time)\n    WHERE scheduled_activation_date IS NOT NULL",
      "CREATE INDEX idx_redemptions_active_period ON redemptions(user_id, status, activation_date, expiration_date)\n    WHERE activation_date IS NOT NULL AND expiration_date IS NOT NULL",
      "CREATE INDEX idx_redemptions_active ON redemptions(user_id, status, deleted_at)\n    WHERE deleted_at IS NULL",
      "-- =============================================\n-- 8. raffle_participations Table\n-- Sub-state table for Raffle missions (participation & winner selection)\n-- Reference: SchemaFinalv2.md lines 888-953\n-- =============================================\n\nCREATE TABLE raffle_participations (\n    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),\n    mission_id UUID NOT NULL REFERENCES missions(id) ON DELETE CASCADE,\n    user_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,\n    mission_progress_id UUID NOT NULL REFERENCES mission_progress(id) ON DELETE CASCADE,\n    redemption_id UUID NOT NULL REFERENCES redemptions(id) ON DELETE CASCADE,\n    client_id UUID NOT NULL REFERENCES clients(id),\n    participated_at TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT NOW(),\n    is_winner BOOLEAN,\n    winner_selected_at TIMESTAMP WITH TIME ZONE,\n    selected_by UUID REFERENCES users(id),\n    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),\n    updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),\n    -- One entry per raffle per user\n    UNIQUE(mission_id, user_id),\n    -- is_winner and winner_selected_at must both be NULL or both NOT NULL\n    CONSTRAINT check_winner_consistency CHECK (\n        (is_winner IS NULL AND winner_selected_at IS NULL) OR\n        (is_winner IS NOT NULL AND winner_selected_at IS NOT NULL)\n    ),\n    -- Composite FK to enforce client_id matching with parent redemption\n    FOREIGN KEY (redemption_id, client_id) REFERENCES redemptions(id, client_id)\n)",
      "CREATE INDEX idx_raffle_mission ON raffle_participations(mission_id, is_winner)",
      "CREATE INDEX idx_raffle_user ON raffle_participations(user_id, mission_id)",
      "CREATE INDEX idx_raffle_winner ON raffle_participations(is_winner, winner_selected_at) WHERE is_winner = true",
      "CREATE INDEX idx_raffle_redemption ON raffle_participations(redemption_id)",
      "-- =============================================\n-- 5. commission_boost_redemptions Table\n-- Sub-state table for Commission Boost rewards (6-state sub-schema)\n-- Reference: SchemaFinalv2.md lines 662-742\n-- =============================================\n\nCREATE TABLE commission_boost_redemptions (\n    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),\n    redemption_id UUID UNIQUE NOT NULL REFERENCES redemptions(id) ON DELETE CASCADE,\n    client_id UUID NOT NULL REFERENCES clients(id),\n    boost_status VARCHAR(50) NOT NULL DEFAULT 'scheduled'\n        CHECK (boost_status IN ('scheduled', 'active', 'expired', 'pending_info', 'pending_payout', 'paid')),\n    scheduled_activation_date DATE NOT NULL,\n    activated_at TIMESTAMP WITH TIME ZONE,\n    expires_at TIMESTAMP WITH TIME ZONE,\n    duration_days INTEGER NOT NULL DEFAULT 30,\n    boost_rate DECIMAL(5, 2) NOT NULL,\n    tier_commission_rate DECIMAL(5, 2),\n    sales_at_activation DECIMAL(10, 2),\n    sales_at_expiration DECIMAL(10, 2),\n    sales_delta DECIMAL(10, 2) GENERATED ALWAYS AS (GREATEST(0, sales_at_expiration - sales_at_activation)) STORED,\n    calculated_commission DECIMAL(10, 2),\n    admin_adjusted_commission DECIMAL(10, 2),\n    final_payout_amount DECIMAL(10, 2),\n    payment_method VARCHAR(20)\n        CHECK (payment_method IN ('venmo', 'paypal')),\n    payment_account VARCHAR(255),\n    payment_account_confirm VARCHAR(255),\n    payment_info_collected_at TIMESTAMP WITH TIME ZONE,\n    payment_info_confirmed BOOLEAN DEFAULT false,\n    payout_sent_at TIMESTAMP WITH TIME ZONE,\n    payout_sent_by UUID REFERENCES users(id),\n    payout_notes TEXT,\n    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),\n    updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),\n    -- Composite FK to enforce client_id matching with parent redemption\n    FOREIGN KEY (redemption_id, client_id) REFERENCES redemptions(id, client_id)\n)",
      "CREATE INDEX idx_boost_redemption ON commission_boost_redemptions(redemption_id)",
      "CREATE INDEX idx_boost_status ON commission_boost_redemptions(boost_status)",
      "CREATE INDEX idx_boost_scheduled ON commission_boost_redemptions(scheduled_activation_date)",
      "CREATE INDEX idx_boost_tenant ON commission_boost_redemptions(client_id, boost_status)",
      "-- =============================================\n-- 6. commission_boost_state_history Table\n-- Audit trail for Commission Boost state transitions\n-- Reference: SchemaFinalv2.md lines 746-779\n-- =============================================\n\nCREATE TABLE commission_boost_state_history (\n    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),\n    boost_redemption_id UUID NOT NULL REFERENCES commission_boost_redemptions(id) ON DELETE CASCADE,\n    client_id UUID NOT NULL REFERENCES clients(id),\n    from_status VARCHAR(50),\n    to_status VARCHAR(50),\n    transitioned_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),\n    transitioned_by UUID REFERENCES users(id),\n    transition_type VARCHAR(50)\n        CHECK (transition_type IN ('manual', 'cron', 'api')),\n    notes TEXT,\n    metadata JSONB\n)",
      "CREATE INDEX idx_boost_history_redemption ON commission_boost_state_history(boost_redemption_id, transitioned_at)",
      "CREATE INDEX idx_boost_history_transitioned_by ON commission_boost_state_history(transitioned_by)\n    WHERE transitioned_by IS NOT NULL",
      "-- =============================================\n-- 7. physical_gift_redemptions Table\n-- Sub-state table for Physical Gift rewards (size & shipping info)\n-- Reference: SchemaFinalv2.md lines 820-884\n-- =============================================\n\nCREATE TABLE physical_gift_redemptions (\n    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),\n    redemption_id UUID UNIQUE NOT NULL REFERENCES redemptions(id) ON DELETE CASCADE,\n    client_id UUID NOT NULL REFERENCES clients(id),\n    requires_size BOOLEAN DEFAULT false,\n    size_category VARCHAR(50)\n        CHECK (size_category IS NULL OR size_category IN ('clothing', 'shoes')),\n    size_value VARCHAR(20),\n    size_submitted_at TIMESTAMP WITH TIME ZONE,\n    shipping_recipient_first_name VARCHAR(100) NOT NULL,\n    shipping_recipient_last_name VARCHAR(100) NOT NULL,\n    shipping_address_line1 VARCHAR(255) NOT NULL,\n    shipping_address_line2 VARCHAR(255),\n    shipping_city VARCHAR(100) NOT NULL,\n    shipping_state VARCHAR(100) NOT NULL,\n    shipping_postal_code VARCHAR(20) NOT NULL,\n    shipping_country VARCHAR(100) DEFAULT 'USA',\n    shipping_phone VARCHAR(50),\n    shipping_info_submitted_at TIMESTAMP WITH TIME ZONE NOT NULL,\n    tracking_number VARCHAR(100),\n    carrier VARCHAR(50)\n        CHECK (carrier IS NULL OR carrier IN ('FedEx', 'UPS', 'USPS', 'DHL')),\n    shipped_at TIMESTAMP WITH TIME ZONE,\n    delivered_at TIMESTAMP WITH TIME ZONE,\n    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),\n    updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),\n    -- Size must be provided if required\n    CONSTRAINT check_size_required CHECK (\n        (requires_size = false) OR\n        (requires_size = true AND size_category IS NOT NULL AND size_value IS NOT NULL)\n    ),\n    -- Composite FK to enforce client_id matching with parent redemption\n    FOREIGN KEY (redemption_id, client_id) REFERENCES redemptions(id, client_id)\n)",
      "CREATE INDEX idx_physical_gift_redemption ON physical_gift_redemptions(redemption_id)",
      "CREATE INDEX idx_physical_gift_shipped ON physical_gift_redemptions(shipped_at) WHERE shipped_at IS NOT NULL",
      "CREATE INDEX idx_physical_gift_pending ON physical_gift_redemptions(created_at) WHERE shipped_at IS NULL",
      "-- =============================================\n-- Additional Performance Indexes\n-- Reference: ARCHITECTURE.md Section 3.3, Task 1.4.1-1.4.2\n-- =============================================\n\n-- Users table: multi-tenant and leaderboard optimization\nCREATE INDEX idx_users_client ON users(client_id)",
      "CREATE INDEX idx_users_tiktok_handle ON users(client_id, tiktok_handle)",
      "CREATE INDEX idx_users_leaderboard_rank ON users(client_id, leaderboard_rank) WHERE leaderboard_rank IS NOT NULL",
      "CREATE INDEX idx_users_total_sales ON users(client_id, total_sales DESC) WHERE total_sales IS NOT NULL",
      "CREATE INDEX idx_users_total_units ON users(client_id, total_units DESC) WHERE total_units IS NOT NULL",
      "-- Videos table: user lookup and date filtering\nCREATE INDEX idx_videos_user ON videos(user_id)",
      "CREATE INDEX idx_videos_client ON videos(client_id)",
      "CREATE INDEX idx_videos_post_date ON videos(user_id, post_date)",
      "-- Tiers table: client lookup\nCREATE INDEX idx_tiers_client ON tiers(client_id)",
      "-- Sales adjustments: user and client lookup\nCREATE INDEX idx_sales_adjustments_user ON sales_adjustments(user_id)",
      "CREATE INDEX idx_sales_adjustments_client ON sales_adjustments(client_id)",
      "-- Tier checkpoints: user and client lookup\nCREATE INDEX idx_tier_checkpoints_user ON tier_checkpoints(user_id)",
      "CREATE INDEX idx_tier_checkpoints_client ON tier_checkpoints(client_id)",
      "-- Handle changes: user lookup\nCREATE INDEX idx_handle_changes_user ON handle_changes(user_id)",
      "-- =============================================\n-- SECTION 3: Row Level Security (RLS)\n-- Reference: Loyalty.md lines 173-183\n-- Roles: Creator (read own), System (automation), Admin (full access)\n-- =============================================\n\n-- Enable RLS on all tables\nALTER TABLE clients ENABLE ROW LEVEL SECURITY",
      "ALTER TABLE tiers ENABLE ROW LEVEL SECURITY",
      "ALTER TABLE users ENABLE ROW LEVEL SECURITY",
      "ALTER TABLE otp_codes ENABLE ROW LEVEL SECURITY",
      "ALTER TABLE password_reset_tokens ENABLE ROW LEVEL SECURITY",
      "ALTER TABLE videos ENABLE ROW LEVEL SECURITY",
      "ALTER TABLE sales_adjustments ENABLE ROW LEVEL SECURITY",
      "ALTER TABLE tier_checkpoints ENABLE ROW LEVEL SECURITY",
      "ALTER TABLE handle_changes ENABLE ROW LEVEL SECURITY",
      "ALTER TABLE sync_logs ENABLE ROW LEVEL SECURITY",
      "ALTER TABLE rewards ENABLE ROW LEVEL SECURITY",
      "ALTER TABLE missions ENABLE ROW LEVEL SECURITY",
      "ALTER TABLE mission_progress ENABLE ROW LEVEL SECURITY",
      "ALTER TABLE redemptions ENABLE ROW LEVEL SECURITY",
      "ALTER TABLE raffle_participations ENABLE ROW LEVEL SECURITY",
      "ALTER TABLE commission_boost_redemptions ENABLE ROW LEVEL SECURITY",
      "ALTER TABLE commission_boost_state_history ENABLE ROW LEVEL SECURITY",
      "ALTER TABLE physical_gift_redemptions ENABLE ROW LEVEL SECURITY",
      "-- =============================================\n-- Creator Policies (read own data, limited writes)\n-- Uses auth.uid() to match user_id\n-- =============================================\n\n-- Creators can read their own user record\nCREATE POLICY \"creators_read_own_user\" ON users\n    FOR SELECT USING (id = auth.uid())",
      "-- Creators can update their own user record (email, payment info, etc.)\nCREATE POLICY \"creators_update_own_user\" ON users\n    FOR UPDATE USING (id = auth.uid())",
      "-- Creators can read client config (for branding)\nCREATE POLICY \"creators_read_client\" ON clients\n    FOR SELECT USING (\n        id IN (SELECT client_id FROM users WHERE id = auth.uid())\n    )",
      "-- Creators can read tiers (for tier display)\nCREATE POLICY \"creators_read_tiers\" ON tiers\n    FOR SELECT USING (\n        client_id IN (SELECT client_id FROM users WHERE id = auth.uid())\n    )",
      "-- Creators can read their own videos\nCREATE POLICY \"creators_read_own_videos\" ON videos\n    FOR SELECT USING (user_id = auth.uid())",
      "-- Creators can read rewards (for rewards catalog)\nCREATE POLICY \"creators_read_rewards\" ON rewards\n    FOR SELECT USING (\n        client_id IN (SELECT client_id FROM users WHERE id = auth.uid())\n        AND enabled = true\n    )",
      "-- Creators can read missions (for missions list)\nCREATE POLICY \"creators_read_missions\" ON missions\n    FOR SELECT USING (\n        client_id IN (SELECT client_id FROM users WHERE id = auth.uid())\n        AND enabled = true\n    )",
      "-- Creators can read their own mission progress\nCREATE POLICY \"creators_read_own_mission_progress\" ON mission_progress\n    FOR SELECT USING (user_id = auth.uid())",
      "-- Creators can read their own redemptions\nCREATE POLICY \"creators_read_own_redemptions\" ON redemptions\n    FOR SELECT USING (user_id = auth.uid())",
      "-- Creators can update their own redemptions (claim action)\nCREATE POLICY \"creators_update_own_redemptions\" ON redemptions\n    FOR UPDATE USING (user_id = auth.uid())",
      "-- Creators can read their own raffle participations\nCREATE POLICY \"creators_read_own_raffle_participations\" ON raffle_participations\n    FOR SELECT USING (user_id = auth.uid())",
      "-- Creators can insert raffle participations (participate action)\nCREATE POLICY \"creators_insert_raffle_participations\" ON raffle_participations\n    FOR INSERT WITH CHECK (user_id = auth.uid())",
      "-- Creators can read their own commission boost redemptions (via redemption join)\nCREATE POLICY \"creators_read_own_boost_redemptions\" ON commission_boost_redemptions\n    FOR SELECT USING (\n        redemption_id IN (SELECT id FROM redemptions WHERE user_id = auth.uid())\n    )",
      "-- Creators can update their own boost redemptions (payment info submission)\nCREATE POLICY \"creators_update_own_boost_redemptions\" ON commission_boost_redemptions\n    FOR UPDATE USING (\n        redemption_id IN (SELECT id FROM redemptions WHERE user_id = auth.uid())\n    )",
      "-- Creators can read their own physical gift redemptions\nCREATE POLICY \"creators_read_own_physical_gift_redemptions\" ON physical_gift_redemptions\n    FOR SELECT USING (\n        redemption_id IN (SELECT id FROM redemptions WHERE user_id = auth.uid())\n    )",
      "-- Creators can update their own physical gift redemptions (shipping info)\nCREATE POLICY \"creators_update_own_physical_gift_redemptions\" ON physical_gift_redemptions\n    FOR UPDATE USING (\n        redemption_id IN (SELECT id FROM redemptions WHERE user_id = auth.uid())\n    )",
      "-- =============================================\n-- Admin Policies (full access within client)\n-- Admins identified by is_admin = true in users table\n-- =============================================\n\n-- Admin full access to all tables (client-scoped)\nCREATE POLICY \"admin_full_access_clients\" ON clients\n    FOR ALL USING (\n        id IN (SELECT client_id FROM users WHERE id = auth.uid() AND is_admin = true)\n    )",
      "CREATE POLICY \"admin_full_access_users\" ON users\n    FOR ALL USING (\n        client_id IN (SELECT client_id FROM users WHERE id = auth.uid() AND is_admin = true)\n    )",
      "CREATE POLICY \"admin_full_access_tiers\" ON tiers\n    FOR ALL USING (\n        client_id IN (SELECT client_id FROM users WHERE id = auth.uid() AND is_admin = true)\n    )",
      "CREATE POLICY \"admin_full_access_videos\" ON videos\n    FOR ALL USING (\n        client_id IN (SELECT client_id FROM users WHERE id = auth.uid() AND is_admin = true)\n    )",
      "CREATE POLICY \"admin_full_access_sales_adjustments\" ON sales_adjustments\n    FOR ALL USING (\n        client_id IN (SELECT client_id FROM users WHERE id = auth.uid() AND is_admin = true)\n    )",
      "CREATE POLICY \"admin_full_access_tier_checkpoints\" ON tier_checkpoints\n    FOR ALL USING (\n        client_id IN (SELECT client_id FROM users WHERE id = auth.uid() AND is_admin = true)\n    )",
      "CREATE POLICY \"admin_full_access_handle_changes\" ON handle_changes\n    FOR ALL USING (\n        user_id IN (SELECT id FROM users WHERE client_id IN (\n            SELECT client_id FROM users WHERE id = auth.uid() AND is_admin = true\n        ))\n    )",
      "CREATE POLICY \"admin_full_access_sync_logs\" ON sync_logs\n    FOR ALL USING (\n        client_id IN (SELECT client_id FROM users WHERE id = auth.uid() AND is_admin = true)\n    )",
      "CREATE POLICY \"admin_full_access_rewards\" ON rewards\n    FOR ALL USING (\n        client_id IN (SELECT client_id FROM users WHERE id = auth.uid() AND is_admin = true)\n    )",
      "CREATE POLICY \"admin_full_access_missions\" ON missions\n    FOR ALL USING (\n        client_id IN (SELECT client_id FROM users WHERE id = auth.uid() AND is_admin = true)\n    )",
      "CREATE POLICY \"admin_full_access_mission_progress\" ON mission_progress\n    FOR ALL USING (\n        client_id IN (SELECT client_id FROM users WHERE id = auth.uid() AND is_admin = true)\n    )",
      "CREATE POLICY \"admin_full_access_redemptions\" ON redemptions\n    FOR ALL USING (\n        client_id IN (SELECT client_id FROM users WHERE id = auth.uid() AND is_admin = true)\n    )",
      "CREATE POLICY \"admin_full_access_raffle_participations\" ON raffle_participations\n    FOR ALL USING (\n        client_id IN (SELECT client_id FROM users WHERE id = auth.uid() AND is_admin = true)\n    )",
      "CREATE POLICY \"admin_full_access_boost_redemptions\" ON commission_boost_redemptions\n    FOR ALL USING (\n        client_id IN (SELECT client_id FROM users WHERE id = auth.uid() AND is_admin = true)\n    )",
      "CREATE POLICY \"admin_full_access_boost_history\" ON commission_boost_state_history\n    FOR ALL USING (\n        client_id IN (SELECT client_id FROM users WHERE id = auth.uid() AND is_admin = true)\n    )",
      "CREATE POLICY \"admin_full_access_physical_gift_redemptions\" ON physical_gift_redemptions\n    FOR ALL USING (\n        client_id IN (SELECT client_id FROM users WHERE id = auth.uid() AND is_admin = true)\n    )",
      "-- =============================================\n-- Service Role Policies (for automation/cron jobs)\n-- Service role bypasses RLS by default in Supabase\n-- These policies are for completeness if using anon key with elevated perms\n-- =============================================\n\n-- OTP codes: system can manage (for signup flow)\nCREATE POLICY \"system_manage_otp_codes\" ON otp_codes\n    FOR ALL USING (true)",
      "-- Password reset tokens: system can manage\nCREATE POLICY \"system_manage_password_reset_tokens\" ON password_reset_tokens\n    FOR ALL USING (true)",
      "-- =============================================\n-- SECTION 4: Triggers\n-- Reference: SchemaFinalv2.md lines 721-724, 781-816\n-- =============================================\n\n-- =============================================\n-- Trigger 1: Auto-sync commission boost status to redemptions\n-- When boost_status changes, update parent redemptions.status\n-- Reference: SchemaFinalv2.md lines 721-724\n-- =============================================\n\nCREATE OR REPLACE FUNCTION sync_boost_to_redemption()\nRETURNS TRIGGER AS $\nBEGIN\n    -- Only sync if boost_status actually changed\n    IF OLD.boost_status IS DISTINCT FROM NEW.boost_status THEN\n        UPDATE redemptions\n        SET\n            status = CASE\n                WHEN NEW.boost_status IN ('scheduled', 'active', 'expired', 'pending_info') THEN 'claimed'\n                WHEN NEW.boost_status = 'pending_payout' THEN 'fulfilled'\n                WHEN NEW.boost_status = 'paid' THEN 'concluded'\n                ELSE status  -- No change for unknown states\n            END,\n            updated_at = NOW()\n        WHERE id = NEW.redemption_id;\n    END IF;\n\n    RETURN NEW;\nEND;\n$ LANGUAGE plpgsql",
      "CREATE TRIGGER sync_boost_status\n    AFTER UPDATE ON commission_boost_redemptions\n    FOR EACH ROW\n    EXECUTE FUNCTION sync_boost_to_redemption()",
      "-- =============================================\n-- Trigger 2: Log commission boost state transitions\n-- Audit trail for financial compliance\n-- Reference: SchemaFinalv2.md lines 781-816\n-- =============================================\n\nCREATE OR REPLACE FUNCTION log_boost_transition()\nRETURNS TRIGGER AS $\nBEGIN\n    -- Only log if status actually changed\n    IF OLD.boost_status IS DISTINCT FROM NEW.boost_status THEN\n        INSERT INTO commission_boost_state_history (\n            boost_redemption_id,\n            client_id,\n            from_status,\n            to_status,\n            transitioned_by,\n            transition_type\n        )\n        VALUES (\n            NEW.id,\n            NEW.client_id,\n            OLD.boost_status,\n            NEW.boost_status,\n            NULLIF(current_setting('app.current_user_id', true), '')::UUID,\n            CASE\n                WHEN current_setting('app.current_user_id', true) = '' THEN 'cron'\n                ELSE 'manual'\n            END\n        );\n    END IF;\n\n    RETURN NEW;\nEND;\n$ LANGUAGE plpgsql",
      "CREATE TRIGGER track_boost_transitions\n    AFTER UPDATE ON commission_boost_redemptions\n    FOR EACH ROW\n    EXECUTE FUNCTION log_boost_transition()",
      "-- =============================================\n-- Trigger 3: Updated_at auto-update\n-- Automatically update updated_at on row changes\n-- =============================================\n\nCREATE OR REPLACE FUNCTION update_updated_at()\nRETURNS TRIGGER AS $\nBEGIN\n    NEW.updated_at = NOW();\n    RETURN NEW;\nEND;\n$ LANGUAGE plpgsql",
      "-- Apply updated_at trigger to tables with updated_at column\nCREATE TRIGGER update_clients_updated_at\n    BEFORE UPDATE ON clients\n    FOR EACH ROW EXECUTE FUNCTION update_updated_at()",
      "CREATE TRIGGER update_tiers_updated_at\n    BEFORE UPDATE ON tiers\n    FOR EACH ROW EXECUTE FUNCTION update_updated_at()",
      "CREATE TRIGGER update_users_updated_at\n    BEFORE UPDATE ON users\n    FOR EACH ROW EXECUTE FUNCTION update_updated_at()",
      "CREATE TRIGGER update_videos_updated_at\n    BEFORE UPDATE ON videos\n    FOR EACH ROW EXECUTE FUNCTION update_updated_at()",
      "CREATE TRIGGER update_rewards_updated_at\n    BEFORE UPDATE ON rewards\n    FOR EACH ROW EXECUTE FUNCTION update_updated_at()",
      "CREATE TRIGGER update_mission_progress_updated_at\n    BEFORE UPDATE ON mission_progress\n    FOR EACH ROW EXECUTE FUNCTION update_updated_at()",
      "CREATE TRIGGER update_redemptions_updated_at\n    BEFORE UPDATE ON redemptions\n    FOR EACH ROW EXECUTE FUNCTION update_updated_at()",
      "CREATE TRIGGER update_raffle_participations_updated_at\n    BEFORE UPDATE ON raffle_participations\n    FOR EACH ROW EXECUTE FUNCTION update_updated_at()",
      "CREATE TRIGGER update_commission_boost_redemptions_updated_at\n    BEFORE UPDATE ON commission_boost_redemptions\n    FOR EACH ROW EXECUTE FUNCTION update_updated_at()",
      "CREATE TRIGGER update_physical_gift_redemptions_updated_at\n    BEFORE UPDATE ON physical_gift_redemptions\n    FOR EACH ROW EXECUTE FUNCTION update_updated_at()"
    ]
  },
  {
    "version": "20251129165155",
    "name": "fix_rls_with_security_definer",
    "statements": [
      "-- =============================================\n-- RLS Fix Migration: SECURITY DEFINER Functions\n-- Created: 2025-11-29\n-- Reference: SecurityDefiner.md\n-- =============================================\n--\n-- This migration fixes three RLS issues:\n-- 1. Problem A: Infinite recursion in 20 policies that query users table\n-- 2. Problem B: No anon access for 8 unauthenticated auth routes\n-- 3. Problem C: 2 overly permissive USING(true) policies\n--\n-- Solution: SECURITY DEFINER RPC functions with GRANT/REVOKE access control\n-- =============================================\n\n-- =============================================\n-- SECTION 1: SECURITY DEFINER FUNCTIONS\n-- =============================================\n\n-- =============================================\n-- GROUP A: Auth Route Functions (Anon Access)\n-- These functions are called from API routes before authentication.\n-- They are executed SERVER-SIDE ONLY via the Supabase client.\n-- client_id comes from SERVER environment variable, NOT from user input.\n-- =============================================\n\n-- Find user by handle (for login, check-handle)\nCREATE OR REPLACE FUNCTION auth_find_user_by_handle(\n  p_client_id UUID,\n  p_handle TEXT\n) RETURNS TABLE (\n  id UUID,\n  client_id UUID,\n  tiktok_handle VARCHAR,\n  email VARCHAR,\n  email_verified BOOLEAN,\n  is_admin BOOLEAN,\n  last_login_at TIMESTAMPTZ\n) AS $\n  SELECT u.id, u.client_id, u.tiktok_handle, u.email, u.email_verified, u.is_admin, u.last_login_at\n  FROM public.users u\n  WHERE u.client_id = p_client_id\n  AND u.tiktok_handle = LOWER(p_handle);\n$ LANGUAGE sql STABLE SECURITY DEFINER SET search_path = public",
      "-- Find user by email (for forgot-password)\nCREATE OR REPLACE FUNCTION auth_find_user_by_email(\n  p_client_id UUID,\n  p_email TEXT\n) RETURNS TABLE (\n  id UUID,\n  client_id UUID,\n  tiktok_handle VARCHAR,\n  email VARCHAR,\n  email_verified BOOLEAN,\n  is_admin BOOLEAN\n) AS $\n  SELECT u.id, u.client_id, u.tiktok_handle, u.email, u.email_verified, u.is_admin\n  FROM public.users u\n  WHERE u.client_id = p_client_id\n  AND u.email = LOWER(p_email);\n$ LANGUAGE sql STABLE SECURITY DEFINER SET search_path = public",
      "-- Check handle uniqueness (for signup validation)\nCREATE OR REPLACE FUNCTION auth_handle_exists(\n  p_client_id UUID,\n  p_handle TEXT\n) RETURNS BOOLEAN AS $\n  SELECT EXISTS (\n    SELECT 1 FROM public.users\n    WHERE client_id = p_client_id\n    AND tiktok_handle = LOWER(p_handle)\n  );\n$ LANGUAGE sql STABLE SECURITY DEFINER SET search_path = public",
      "-- Check email uniqueness (for signup validation)\nCREATE OR REPLACE FUNCTION auth_email_exists(\n  p_client_id UUID,\n  p_email TEXT\n) RETURNS BOOLEAN AS $\n  SELECT EXISTS (\n    SELECT 1 FROM public.users\n    WHERE client_id = p_client_id\n    AND email = LOWER(p_email)\n  );\n$ LANGUAGE sql STABLE SECURITY DEFINER SET search_path = public",
      "-- Get client by ID (for email branding, client-config)\nCREATE OR REPLACE FUNCTION auth_get_client_by_id(\n  p_client_id UUID\n) RETURNS TABLE (\n  id UUID,\n  name VARCHAR,\n  subdomain VARCHAR,\n  logo_url TEXT,\n  primary_color VARCHAR\n) AS $\n  SELECT c.id, c.name, c.subdomain, c.logo_url, c.primary_color\n  FROM public.clients c\n  WHERE c.id = p_client_id;\n$ LANGUAGE sql STABLE SECURITY DEFINER SET search_path = public",
      "-- Create user (for signup)\n-- SECURITY: NO p_is_admin parameter - ALWAYS creates non-admin users\n-- This prevents privilege escalation via anon key\nCREATE OR REPLACE FUNCTION auth_create_user(\n  p_id UUID,\n  p_client_id UUID,\n  p_tiktok_handle VARCHAR,\n  p_email VARCHAR,\n  p_password_hash VARCHAR,\n  p_terms_version VARCHAR DEFAULT NULL\n) RETURNS TABLE (\n  id UUID,\n  client_id UUID,\n  tiktok_handle VARCHAR,\n  email VARCHAR,\n  email_verified BOOLEAN,\n  current_tier VARCHAR,\n  is_admin BOOLEAN,\n  terms_accepted_at TIMESTAMPTZ,\n  terms_version VARCHAR,\n  created_at TIMESTAMPTZ\n) AS $\n  INSERT INTO public.users (\n    id, client_id, tiktok_handle, email, password_hash,\n    email_verified, current_tier, is_admin,\n    terms_accepted_at, terms_version\n  ) VALUES (\n    p_id, p_client_id, LOWER(p_tiktok_handle), LOWER(p_email), p_password_hash,\n    false, 'tier_1', false,\n    CASE WHEN p_terms_version IS NOT NULL THEN NOW() ELSE NULL END,\n    p_terms_version\n  )\n  RETURNING id, client_id, tiktok_handle, email, email_verified, current_tier, is_admin, terms_accepted_at, terms_version, created_at;\n$ LANGUAGE sql VOLATILE SECURITY DEFINER SET search_path = public",
      "-- =============================================\n-- GROUP B: Auth Route Functions (Cookie Auth)\n-- These functions are used after signup when user has OTP session cookie.\n-- =============================================\n\n-- Find user by ID (for verify-otp, resend-otp, auth.ts getUserFromRequest)\nCREATE OR REPLACE FUNCTION auth_find_user_by_id(\n  p_user_id UUID\n) RETURNS TABLE (\n  id UUID,\n  client_id UUID,\n  tiktok_handle VARCHAR,\n  email VARCHAR,\n  email_verified BOOLEAN,\n  current_tier VARCHAR,\n  is_admin BOOLEAN\n) AS $\n  SELECT u.id, u.client_id, u.tiktok_handle, u.email, u.email_verified, u.current_tier, u.is_admin\n  FROM public.users u\n  WHERE u.id = p_user_id;\n$ LANGUAGE sql STABLE SECURITY DEFINER SET search_path = public",
      "-- Mark email verified (for verify-otp)\nCREATE OR REPLACE FUNCTION auth_mark_email_verified(\n  p_user_id UUID\n) RETURNS VOID AS $\n  UPDATE public.users\n  SET email_verified = true, updated_at = NOW()\n  WHERE id = p_user_id;\n$ LANGUAGE sql VOLATILE SECURITY DEFINER SET search_path = public",
      "-- Update last login (for verify-otp, login)\nCREATE OR REPLACE FUNCTION auth_update_last_login(\n  p_user_id UUID\n) RETURNS VOID AS $\n  UPDATE public.users\n  SET last_login_at = NOW(), updated_at = NOW()\n  WHERE id = p_user_id;\n$ LANGUAGE sql VOLATILE SECURITY DEFINER SET search_path = public",
      "-- =============================================\n-- GROUP C: Admin Check Functions (Fix Recursion)\n-- These are called BY RLS policies, not directly by app code.\n-- =============================================\n\n-- Check if current user is admin of a client (breaks recursion)\n-- Guards against auth.uid() IS NULL to prevent unexpected behavior\nCREATE OR REPLACE FUNCTION is_admin_of_client(\n  p_client_id UUID\n) RETURNS BOOLEAN AS $\n  SELECT CASE\n    WHEN auth.uid() IS NULL THEN false\n    ELSE EXISTS (\n      SELECT 1 FROM public.users\n      WHERE id = auth.uid()\n      AND client_id = p_client_id\n      AND is_admin = true\n    )\n  END;\n$ LANGUAGE sql STABLE SECURITY DEFINER SET search_path = public",
      "-- Get current user's client_id (for creator policies)\n-- Returns NULL if auth.uid() IS NULL (unauthenticated)\nCREATE OR REPLACE FUNCTION get_current_user_client_id()\nRETURNS UUID AS $\n  SELECT CASE\n    WHEN auth.uid() IS NULL THEN NULL\n    ELSE (SELECT client_id FROM public.users WHERE id = auth.uid())\n  END;\n$ LANGUAGE sql STABLE SECURITY DEFINER SET search_path = public",
      "-- =============================================\n-- GROUP D: OTP Functions (Unauthenticated Access)\n-- =============================================\n\n-- Create OTP code (called during signup before auth)\nCREATE OR REPLACE FUNCTION auth_create_otp(\n  p_user_id UUID,\n  p_session_id TEXT,\n  p_code_hash TEXT,\n  p_expires_at TIMESTAMPTZ\n) RETURNS UUID AS $\n  INSERT INTO public.otp_codes (user_id, session_id, code_hash, expires_at, attempts, used)\n  VALUES (p_user_id, p_session_id, p_code_hash, p_expires_at, 0, false)\n  RETURNING id;\n$ LANGUAGE sql VOLATILE SECURITY DEFINER SET search_path = public",
      "-- Find OTP by session ID (called during verify-otp)\nCREATE OR REPLACE FUNCTION auth_find_otp_by_session(\n  p_session_id TEXT\n) RETURNS TABLE (\n  id UUID,\n  user_id UUID,\n  session_id TEXT,\n  code_hash TEXT,\n  expires_at TIMESTAMPTZ,\n  attempts INTEGER,\n  used BOOLEAN,\n  created_at TIMESTAMPTZ\n) AS $\n  SELECT o.id, o.user_id, o.session_id, o.code_hash, o.expires_at, o.attempts, o.used, o.created_at\n  FROM public.otp_codes o\n  WHERE o.session_id = p_session_id\n  ORDER BY o.created_at DESC\n  LIMIT 1;\n$ LANGUAGE sql STABLE SECURITY DEFINER SET search_path = public",
      "-- Mark OTP as used\nCREATE OR REPLACE FUNCTION auth_mark_otp_used(\n  p_session_id TEXT\n) RETURNS VOID AS $\n  UPDATE public.otp_codes\n  SET used = true\n  WHERE session_id = p_session_id;\n$ LANGUAGE sql VOLATILE SECURITY DEFINER SET search_path = public",
      "-- Increment OTP attempts\nCREATE OR REPLACE FUNCTION auth_increment_otp_attempts(\n  p_session_id TEXT\n) RETURNS INTEGER AS $\n  UPDATE public.otp_codes\n  SET attempts = attempts + 1\n  WHERE session_id = p_session_id\n  RETURNING attempts;\n$ LANGUAGE sql VOLATILE SECURITY DEFINER SET search_path = public",
      "-- =============================================\n-- GROUP E: Password Reset Functions (Unauthenticated Access)\n-- =============================================\n\n-- Create password reset token\nCREATE OR REPLACE FUNCTION auth_create_reset_token(\n  p_user_id UUID,\n  p_token_hash TEXT,\n  p_expires_at TIMESTAMPTZ,\n  p_ip_address TEXT DEFAULT NULL\n) RETURNS UUID AS $\n  INSERT INTO public.password_reset_tokens (user_id, token_hash, expires_at, ip_address)\n  VALUES (p_user_id, p_token_hash, p_expires_at, p_ip_address)\n  RETURNING id;\n$ LANGUAGE sql VOLATILE SECURITY DEFINER SET search_path = public",
      "-- Find all valid reset tokens (for bcrypt comparison)\nCREATE OR REPLACE FUNCTION auth_find_valid_reset_tokens()\nRETURNS TABLE (\n  id UUID,\n  user_id UUID,\n  token_hash TEXT,\n  expires_at TIMESTAMPTZ,\n  used_at TIMESTAMPTZ\n) AS $\n  SELECT t.id, t.user_id, t.token_hash, t.expires_at, t.used_at\n  FROM public.password_reset_tokens t\n  WHERE t.used_at IS NULL\n  AND t.expires_at > NOW();\n$ LANGUAGE sql STABLE SECURITY DEFINER SET search_path = public",
      "-- Find recent tokens by user (for rate limiting)\nCREATE OR REPLACE FUNCTION auth_find_recent_reset_tokens(\n  p_user_id UUID\n) RETURNS TABLE (\n  id UUID,\n  created_at TIMESTAMPTZ\n) AS $\n  SELECT t.id, t.created_at\n  FROM public.password_reset_tokens t\n  WHERE t.user_id = p_user_id\n  AND t.created_at > NOW() - INTERVAL '1 hour';\n$ LANGUAGE sql STABLE SECURITY DEFINER SET search_path = public",
      "-- Mark reset token as used\nCREATE OR REPLACE FUNCTION auth_mark_reset_token_used(\n  p_token_id UUID\n) RETURNS VOID AS $\n  UPDATE public.password_reset_tokens\n  SET used_at = NOW()\n  WHERE id = p_token_id;\n$ LANGUAGE sql VOLATILE SECURITY DEFINER SET search_path = public",
      "-- Invalidate all tokens for user\nCREATE OR REPLACE FUNCTION auth_invalidate_user_reset_tokens(\n  p_user_id UUID\n) RETURNS VOID AS $\n  UPDATE public.password_reset_tokens\n  SET used_at = NOW()\n  WHERE user_id = p_user_id\n  AND used_at IS NULL;\n$ LANGUAGE sql VOLATILE SECURITY DEFINER SET search_path = public",
      "-- =============================================\n-- SECTION 2: GRANT/REVOKE ACCESS CONTROL\n-- CRITICAL: Without this, all functions are executable by PUBLIC\n-- =============================================\n\n-- =============================================\n-- REVOKE ALL FROM PUBLIC (security baseline)\n-- =============================================\n\n-- Group A: Auth Route Functions\nREVOKE ALL ON FUNCTION auth_find_user_by_handle(UUID, TEXT) FROM PUBLIC",
      "REVOKE ALL ON FUNCTION auth_find_user_by_email(UUID, TEXT) FROM PUBLIC",
      "REVOKE ALL ON FUNCTION auth_handle_exists(UUID, TEXT) FROM PUBLIC",
      "REVOKE ALL ON FUNCTION auth_email_exists(UUID, TEXT) FROM PUBLIC",
      "REVOKE ALL ON FUNCTION auth_get_client_by_id(UUID) FROM PUBLIC",
      "REVOKE ALL ON FUNCTION auth_create_user(UUID, UUID, VARCHAR, VARCHAR, VARCHAR, VARCHAR) FROM PUBLIC",
      "-- Group B: Cookie Auth Functions\nREVOKE ALL ON FUNCTION auth_find_user_by_id(UUID) FROM PUBLIC",
      "REVOKE ALL ON FUNCTION auth_mark_email_verified(UUID) FROM PUBLIC",
      "REVOKE ALL ON FUNCTION auth_update_last_login(UUID) FROM PUBLIC",
      "-- Group C: Admin Check Functions (used by RLS policies)\nREVOKE ALL ON FUNCTION is_admin_of_client(UUID) FROM PUBLIC",
      "REVOKE ALL ON FUNCTION get_current_user_client_id() FROM PUBLIC",
      "-- Group D: OTP Functions\nREVOKE ALL ON FUNCTION auth_create_otp(UUID, TEXT, TEXT, TIMESTAMPTZ) FROM PUBLIC",
      "REVOKE ALL ON FUNCTION auth_find_otp_by_session(TEXT) FROM PUBLIC",
      "REVOKE ALL ON FUNCTION auth_mark_otp_used(TEXT) FROM PUBLIC",
      "REVOKE ALL ON FUNCTION auth_increment_otp_attempts(TEXT) FROM PUBLIC",
      "-- Group E: Password Reset Functions\nREVOKE ALL ON FUNCTION auth_create_reset_token(UUID, TEXT, TIMESTAMPTZ, TEXT) FROM PUBLIC",
      "REVOKE ALL ON FUNCTION auth_find_valid_reset_tokens() FROM PUBLIC",
      "REVOKE ALL ON FUNCTION auth_find_recent_reset_tokens(UUID) FROM PUBLIC",
      "REVOKE ALL ON FUNCTION auth_mark_reset_token_used(UUID) FROM PUBLIC",
      "REVOKE ALL ON FUNCTION auth_invalidate_user_reset_tokens(UUID) FROM PUBLIC",
      "-- =============================================\n-- GRANT EXECUTE TO service_role\n-- This is the role used by our API server (SUPABASE_SERVICE_ROLE_KEY)\n-- =============================================\n\n-- Group A: Auth Route Functions (called by API routes before auth)\nGRANT EXECUTE ON FUNCTION auth_find_user_by_handle(UUID, TEXT) TO service_role",
      "GRANT EXECUTE ON FUNCTION auth_find_user_by_email(UUID, TEXT) TO service_role",
      "GRANT EXECUTE ON FUNCTION auth_handle_exists(UUID, TEXT) TO service_role",
      "GRANT EXECUTE ON FUNCTION auth_email_exists(UUID, TEXT) TO service_role",
      "GRANT EXECUTE ON FUNCTION auth_get_client_by_id(UUID) TO service_role",
      "GRANT EXECUTE ON FUNCTION auth_create_user(UUID, UUID, VARCHAR, VARCHAR, VARCHAR, VARCHAR) TO service_role",
      "-- Group B: Cookie Auth Functions (called by API routes with OTP session)\nGRANT EXECUTE ON FUNCTION auth_find_user_by_id(UUID) TO service_role",
      "GRANT EXECUTE ON FUNCTION auth_mark_email_verified(UUID) TO service_role",
      "GRANT EXECUTE ON FUNCTION auth_update_last_login(UUID) TO service_role",
      "-- Group C: Admin Check Functions (called by RLS policies for authenticated users)\n-- These need to be executable by authenticated users for policies to work\nGRANT EXECUTE ON FUNCTION is_admin_of_client(UUID) TO authenticated",
      "GRANT EXECUTE ON FUNCTION get_current_user_client_id() TO authenticated",
      "-- Group D: OTP Functions (called by API routes)\nGRANT EXECUTE ON FUNCTION auth_create_otp(UUID, TEXT, TEXT, TIMESTAMPTZ) TO service_role",
      "GRANT EXECUTE ON FUNCTION auth_find_otp_by_session(TEXT) TO service_role",
      "GRANT EXECUTE ON FUNCTION auth_mark_otp_used(TEXT) TO service_role",
      "GRANT EXECUTE ON FUNCTION auth_increment_otp_attempts(TEXT) TO service_role",
      "-- Group E: Password Reset Functions (called by API routes)\nGRANT EXECUTE ON FUNCTION auth_create_reset_token(UUID, TEXT, TIMESTAMPTZ, TEXT) TO service_role",
      "GRANT EXECUTE ON FUNCTION auth_find_valid_reset_tokens() TO service_role",
      "GRANT EXECUTE ON FUNCTION auth_find_recent_reset_tokens(UUID) TO service_role",
      "GRANT EXECUTE ON FUNCTION auth_mark_reset_token_used(UUID) TO service_role",
      "GRANT EXECUTE ON FUNCTION auth_invalidate_user_reset_tokens(UUID) TO service_role",
      "-- =============================================\n-- SECTION 3: UPDATE RLS POLICIES\n-- =============================================\n\n-- =============================================\n-- DROP ALL EXISTING PROBLEMATIC POLICIES\n-- =============================================\n\n-- Admin policies (16 total)\nDROP POLICY IF EXISTS \"admin_full_access_clients\" ON public.clients",
      "DROP POLICY IF EXISTS \"admin_full_access_users\" ON public.users",
      "DROP POLICY IF EXISTS \"admin_full_access_tiers\" ON public.tiers",
      "DROP POLICY IF EXISTS \"admin_full_access_videos\" ON public.videos",
      "DROP POLICY IF EXISTS \"admin_full_access_sales_adjustments\" ON public.sales_adjustments",
      "DROP POLICY IF EXISTS \"admin_full_access_tier_checkpoints\" ON public.tier_checkpoints",
      "DROP POLICY IF EXISTS \"admin_full_access_handle_changes\" ON public.handle_changes",
      "DROP POLICY IF EXISTS \"admin_full_access_sync_logs\" ON public.sync_logs",
      "DROP POLICY IF EXISTS \"admin_full_access_rewards\" ON public.rewards",
      "DROP POLICY IF EXISTS \"admin_full_access_missions\" ON public.missions",
      "DROP POLICY IF EXISTS \"admin_full_access_mission_progress\" ON public.mission_progress",
      "DROP POLICY IF EXISTS \"admin_full_access_redemptions\" ON public.redemptions",
      "DROP POLICY IF EXISTS \"admin_full_access_raffle_participations\" ON public.raffle_participations",
      "DROP POLICY IF EXISTS \"admin_full_access_boost_redemptions\" ON public.commission_boost_redemptions",
      "DROP POLICY IF EXISTS \"admin_full_access_boost_history\" ON public.commission_boost_state_history",
      "DROP POLICY IF EXISTS \"admin_full_access_physical_gift_redemptions\" ON public.physical_gift_redemptions",
      "-- Creator policies that subquery users table (4 total)\nDROP POLICY IF EXISTS \"creators_read_client\" ON public.clients",
      "DROP POLICY IF EXISTS \"creators_read_tiers\" ON public.tiers",
      "DROP POLICY IF EXISTS \"creators_read_rewards\" ON public.rewards",
      "DROP POLICY IF EXISTS \"creators_read_missions\" ON public.missions",
      "-- System policies (will be replaced with deny-all + RPC access)\nDROP POLICY IF EXISTS \"system_manage_otp_codes\" ON public.otp_codes",
      "DROP POLICY IF EXISTS \"system_manage_password_reset_tokens\" ON public.password_reset_tokens",
      "-- =============================================\n-- RECREATE ADMIN POLICIES (using helper function)\n-- =============================================\n\nCREATE POLICY \"admin_full_access_clients\" ON public.clients\n    FOR ALL USING (is_admin_of_client(id))",
      "CREATE POLICY \"admin_full_access_users\" ON public.users\n    FOR ALL USING (is_admin_of_client(client_id))",
      "CREATE POLICY \"admin_full_access_tiers\" ON public.tiers\n    FOR ALL USING (is_admin_of_client(client_id))",
      "CREATE POLICY \"admin_full_access_videos\" ON public.videos\n    FOR ALL USING (is_admin_of_client(client_id))",
      "CREATE POLICY \"admin_full_access_sales_adjustments\" ON public.sales_adjustments\n    FOR ALL USING (is_admin_of_client(client_id))",
      "CREATE POLICY \"admin_full_access_tier_checkpoints\" ON public.tier_checkpoints\n    FOR ALL USING (is_admin_of_client(client_id))",
      "CREATE POLICY \"admin_full_access_handle_changes\" ON public.handle_changes\n    FOR ALL USING (is_admin_of_client(\n        (SELECT client_id FROM public.users WHERE id = handle_changes.user_id)\n    ))",
      "CREATE POLICY \"admin_full_access_sync_logs\" ON public.sync_logs\n    FOR ALL USING (is_admin_of_client(client_id))",
      "CREATE POLICY \"admin_full_access_rewards\" ON public.rewards\n    FOR ALL USING (is_admin_of_client(client_id))",
      "CREATE POLICY \"admin_full_access_missions\" ON public.missions\n    FOR ALL USING (is_admin_of_client(client_id))",
      "CREATE POLICY \"admin_full_access_mission_progress\" ON public.mission_progress\n    FOR ALL USING (is_admin_of_client(client_id))",
      "CREATE POLICY \"admin_full_access_redemptions\" ON public.redemptions\n    FOR ALL USING (is_admin_of_client(client_id))",
      "CREATE POLICY \"admin_full_access_raffle_participations\" ON public.raffle_participations\n    FOR ALL USING (is_admin_of_client(client_id))",
      "CREATE POLICY \"admin_full_access_boost_redemptions\" ON public.commission_boost_redemptions\n    FOR ALL USING (is_admin_of_client(client_id))",
      "CREATE POLICY \"admin_full_access_boost_history\" ON public.commission_boost_state_history\n    FOR ALL USING (is_admin_of_client(client_id))",
      "CREATE POLICY \"admin_full_access_physical_gift_redemptions\" ON public.physical_gift_redemptions\n    FOR ALL USING (is_admin_of_client(client_id))",
      "-- =============================================\n-- RECREATE CREATOR POLICIES (using helper function)\n-- =============================================\n\nCREATE POLICY \"creators_read_client\" ON public.clients\n    FOR SELECT USING (id = get_current_user_client_id())",
      "CREATE POLICY \"creators_read_tiers\" ON public.tiers\n    FOR SELECT USING (client_id = get_current_user_client_id())",
      "CREATE POLICY \"creators_read_rewards\" ON public.rewards\n    FOR SELECT USING (\n        client_id = get_current_user_client_id()\n        AND enabled = true\n    )",
      "CREATE POLICY \"creators_read_missions\" ON public.missions\n    FOR SELECT USING (\n        client_id = get_current_user_client_id()\n        AND enabled = true\n    )",
      "-- =============================================\n-- OTP/RESET TOKEN POLICIES\n-- DENY ALL direct access - all operations go through RPC functions.\n-- This is MORE secure than USING(true) since RPC functions bypass RLS anyway.\n-- =============================================\n\n-- OTP codes: Deny all direct access (RPC functions bypass this via SECURITY DEFINER)\nCREATE POLICY \"deny_direct_otp_access\" ON public.otp_codes\n    FOR ALL USING (false)",
      "-- Password reset tokens: Deny all direct access\nCREATE POLICY \"deny_direct_reset_access\" ON public.password_reset_tokens\n    FOR ALL USING (false)",
      "-- =============================================\n-- END OF MIGRATION\n-- ============================================="
    ]
  },
  {
    "version": "20251202",
    "name": "cr001_session_tokens_in_otp",
    "statements": [
      "-- CR-001: Fix Session Creation After OTP Verification\r\n--\r\n-- Problem: verifyOTP() calls getUserById() expecting it to create a session,\r\n--          but getUserById() only fetches user data, doesn't create sessions.\r\n--\r\n-- Solution: Store encrypted session tokens from signup in OTP record,\r\n--           return them after OTP verification.\r\n--\r\n-- References:\r\n-- - /repodocs/LoginFlowFix.md (full implementation guide)\r\n-- - EXECUTION_STATUS.md CR-001\r\n\r\n-- =============================================================================\r\n-- Step 1: Add session token columns to otp_codes table\r\n-- =============================================================================\r\n\r\nALTER TABLE public.otp_codes\r\nADD COLUMN IF NOT EXISTS access_token_encrypted TEXT,\r\nADD COLUMN IF NOT EXISTS refresh_token_encrypted TEXT",
      "COMMENT ON COLUMN public.otp_codes.access_token_encrypted IS 'AES-256-GCM encrypted Supabase access_token from signup (cleared after use)'",
      "COMMENT ON COLUMN public.otp_codes.refresh_token_encrypted IS 'AES-256-GCM encrypted Supabase refresh_token from signup (cleared after use)'",
      "-- =============================================================================\r\n-- Step 2: Update auth_create_otp to accept session tokens\r\n-- =============================================================================\r\n\r\nCREATE OR REPLACE FUNCTION auth_create_otp(\r\n  p_user_id UUID,\r\n  p_session_id TEXT,\r\n  p_code_hash TEXT,\r\n  p_expires_at TIMESTAMPTZ,\r\n  p_access_token_encrypted TEXT DEFAULT NULL,\r\n  p_refresh_token_encrypted TEXT DEFAULT NULL\r\n) RETURNS UUID AS $\r\n  INSERT INTO public.otp_codes (\r\n    user_id,\r\n    session_id,\r\n    code_hash,\r\n    expires_at,\r\n    attempts,\r\n    used,\r\n    access_token_encrypted,\r\n    refresh_token_encrypted\r\n  )\r\n  VALUES (\r\n    p_user_id,\r\n    p_session_id,\r\n    p_code_hash,\r\n    p_expires_at,\r\n    0,\r\n    false,\r\n    p_access_token_encrypted,\r\n    p_refresh_token_encrypted\r\n  )\r\n  RETURNING id;\r\n$ LANGUAGE sql VOLATILE SECURITY DEFINER SET search_path = public",
      "-- =============================================================================\r\n-- Step 3: Update auth_find_otp_by_session to return session tokens\r\n-- Note: Must DROP first because we're changing the return type\r\n-- =============================================================================\r\n\r\nDROP FUNCTION IF EXISTS auth_find_otp_by_session(TEXT)",
      "CREATE OR REPLACE FUNCTION auth_find_otp_by_session(\r\n  p_session_id TEXT\r\n) RETURNS TABLE (\r\n  id UUID,\r\n  user_id UUID,\r\n  session_id TEXT,\r\n  code_hash TEXT,\r\n  expires_at TIMESTAMPTZ,\r\n  attempts INTEGER,\r\n  used BOOLEAN,\r\n  created_at TIMESTAMPTZ,\r\n  access_token_encrypted TEXT,\r\n  refresh_token_encrypted TEXT\r\n) AS $\r\n  SELECT\r\n    o.id,\r\n    o.user_id,\r\n    o.session_id,\r\n    o.code_hash,\r\n    o.expires_at,\r\n    o.attempts,\r\n    o.used,\r\n    o.created_at,\r\n    o.access_token_encrypted,\r\n    o.refresh_token_encrypted\r\n  FROM public.otp_codes o\r\n  WHERE o.session_id = p_session_id\r\n  ORDER BY o.created_at DESC\r\n  LIMIT 1;\r\n$ LANGUAGE sql STABLE SECURITY DEFINER SET search_path = public",
      "-- =============================================================================\r\n-- Step 4: Update auth_mark_otp_used to clear tokens (security)\r\n-- =============================================================================\r\n\r\nCREATE OR REPLACE FUNCTION auth_mark_otp_used(\r\n  p_session_id TEXT\r\n) RETURNS VOID AS $\r\n  UPDATE public.otp_codes\r\n  SET\r\n    used = true,\r\n    access_token_encrypted = NULL,\r\n    refresh_token_encrypted = NULL\r\n  WHERE session_id = p_session_id;\r\n$ LANGUAGE sql VOLATILE SECURITY DEFINER SET search_path = public",
      "-- =============================================================================\r\n-- Verification queries (run manually after migration)\r\n-- =============================================================================\r\n-- SELECT column_name, data_type FROM information_schema.columns\r\n-- WHERE table_name = 'otp_codes' AND column_name LIKE '%token%';\r\n--\r\n-- Expected: access_token_encrypted (text), refresh_token_encrypted (text)"
    ]
  }
]
